<!-- Loading State -->
<div *ngIf="loading" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
  <div class="text-center">
    <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading comprehensive review data...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="alert alert-danger" role="alert">
  <i class="fas fa-exclamation-triangle me-2"></i>
  {{ error }}
  <button class="btn btn-outline-danger btn-sm ms-3" (click)="loadComprehensiveData()">
    <i class="fas fa-redo me-1"></i> Retry
  </button>
</div>

<!-- Main Content -->
<div *ngIf="!loading && !error && escalation" class="comprehensive-review">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <button class="btn btn-outline-secondary me-3" (click)="goBack()">
        <i class="fas fa-arrow-left me-2"></i>Back to Escalations
      </button>
      <h2 class="mb-0">Comprehensive Compliance Review</h2>
      <p class="text-muted mb-2">Assignment ID: {{ assignmentId }}</p>
      
      <!-- Loan ID Display -->
      <div *ngIf="escalation?.loanId">
        <app-loan-id-display 
          [internalLoanId]="escalation.loanId"
          displayType="badge"
          size="medium"
          badgeColor="warning"
          [showLabel]="false">
        </app-loan-id-display>
      </div>
    </div>
    <div>
      <button class="btn btn-danger" 
              (click)="openVerdictModal()"
              [disabled]="verdictSubmitted || verdictSubmitting"
              [class.btn-secondary]="verdictSubmitted"
              [class.btn-danger]="!verdictSubmitted"
              [title]="getVerdictButtonMessage()">
        <i class="fas" 
           [class.fa-gavel]="!verdictSubmitted && !verdictSubmitting"
           [class.fa-check-circle]="verdictSubmitted"
           [class.fa-spinner]="verdictSubmitting"
           [class.fa-spin]="verdictSubmitting"
           class="me-2"></i>
        {{ verdictSubmitting ? 'Submitting...' : (verdictSubmitted ? 'Verdict Submitted' : 'Submit Verdict') }}
      </button>
      <div *ngIf="verdictSubmitted" class="mt-2">
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          Verdict has been submitted. You can only view this case now.
        </small>
      </div>
    </div>
  </div>

  <!-- Risk Overview Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-3">
              <div class="text-center">
                <div class="risk-circle" [style.border-color]="getRiskColor(escalation.riskLevel)">
                  <div class="risk-score">{{ escalation.riskScore }}</div>
                  <div class="risk-label">Risk Score</div>
                </div>
              </div>
            </div>
            <div class="col-md-9">
              <div class="row">
                <div class="col-md-3">
                  <h6 class="text-muted mb-1">Applicant</h6>
                  <p class="fw-bold mb-0">{{ escalation.applicantName }}</p>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted mb-1">Loan Type</h6>
                  <p class="fw-bold mb-0">{{ escalation.loanType }}</p>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted mb-1">Amount</h6>
                  <p class="fw-bold mb-0">{{ formatCurrency(escalation.loanAmount) }}</p>
                </div>
                <div class="col-md-3">
                  <h6 class="text-muted mb-1">Risk Level</h6>
                  <span [class]="getRiskBadgeClass(escalation.riskLevel)">{{ escalation.riskLevel }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-4" id="reviewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'overview'"
        (click)="setActiveTab('overview')"
        type="button">
        <i class="fas fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'documents'"
        (click)="setActiveTab('documents')"
        type="button">
        <i class="fas fa-file-alt me-2"></i>Documents
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'fraud-data'"
        (click)="setActiveTab('fraud-data')"
        type="button">
        <i class="fas fa-shield-alt me-2"></i>External Fraud Data
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'screening'"
        (click)="setActiveTab('screening')"
        type="button">
        <i class="fas fa-search me-2"></i>Screening Results
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'flags'"
        (click)="setActiveTab('flags')"
        type="button">
        <i class="fas fa-flag me-2"></i>Fraud Flags
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- Overview Tab -->
    <div *ngIf="activeTab === 'overview'" class="tab-pane fade show active">
      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-user me-2"></i>Applicant Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <p><strong>Name:</strong> {{ escalation.applicantName }}</p>
                  <p><strong>Applicant ID:</strong> {{ escalation.applicantId }}</p>
                </div>
                <div class="col-6">
                  <p><strong>Assigned At:</strong> {{ formatDate(escalation.assignedAt) }}</p>
                  <p><strong>Status:</strong> 
                    <span [class]="complianceService.getStatusBadgeClass(escalation.status)">
                      {{ escalation.status }}
                    </span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-money-bill me-2"></i>Loan Details</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <p><strong>Loan ID:</strong> {{ escalation.loanId }}</p>
                  <p><strong>Type:</strong> {{ escalation.loanType }}</p>
                </div>
                <div class="col-6">
                  <p><strong>Amount:</strong> {{ formatCurrency(escalation.loanAmount) }}</p>
                  <p><strong>Risk Score:</strong> {{ escalation.riskScore }}/100</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Escalation Details -->
      <div class="card mb-4" *ngIf="escalation.escalationReason || escalation.remarks">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Escalation Details</h5>
        </div>
        <div class="card-body">
          <div *ngIf="escalation.escalationReason">
            <h6>Escalation Reason:</h6>
            <p class="text-muted">{{ escalation.escalationReason }}</p>
          </div>
          <div *ngIf="escalation.remarks">
            <h6>Officer Remarks:</h6>
            <p class="text-muted">{{ escalation.remarks }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div *ngIf="activeTab === 'documents'" class="tab-pane fade show active">
      <!-- Header Section -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h4 fw-bold mb-1" style="color: var(--text-primary);">
            <i class="fas fa-file-check me-2 text-danger"></i>Document Verification
          </h2>
          <p class="text-muted mb-0">Review and verify applicant documents</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" (click)="goBack()">
            <i class="fas fa-arrow-left me-2"></i>Back to Escalations
          </button>
        </div>
      </div>

      <!-- Verification Progress -->
      <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-primary);" *ngIf="loanDocuments.length > 0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-tasks me-2 text-danger"></i>Verification Progress
            </h6>
            <span class="badge" 
                  [class.bg-success]="getVerifiedCount() === loanDocuments.length"
                  [class.bg-warning]="getVerifiedCount() !== loanDocuments.length">
              {{ getVerifiedCount() }} / {{ loanDocuments.length }} Verified
            </span>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" 
                 [class.bg-success]="getVerifiedCount() === loanDocuments.length"
                 [class.bg-warning]="getVerifiedCount() !== loanDocuments.length"
                 role="progressbar" 
                 [style.width.%]="(getVerifiedCount() / loanDocuments.length) * 100"
                 [attr.aria-valuenow]="getVerifiedCount()"
                 [attr.aria-valuemin]="0"
                 [attr.aria-valuemax]="loanDocuments.length">
            </div>
          </div>
          <small class="text-muted mt-2 d-block" *ngIf="getVerifiedCount() !== loanDocuments.length">
            <i class="fas fa-info-circle me-1"></i>Complete document review for compliance assessment
          </small>
          <small class="text-success mt-2 d-block" *ngIf="getVerifiedCount() === loanDocuments.length">
            <i class="fas fa-check-circle me-1"></i>All documents reviewed! Ready for compliance verdict.
          </small>
        </div>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show mb-3">
        <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="alert alert-danger alert-dismissible fade show mb-3">
        <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
        <button type="button" class="btn-close" (click)="error = ''"></button>
      </div>

      <!-- Documents Grid -->
      <div class="row g-4">
        <div class="col-lg-4 col-md-6" *ngFor="let doc of loanDocuments; let i = index">
          <div class="card border-0 shadow-sm h-100 animate-slide-up" 
               [style.animation-delay.s]="i * 0.1"
               style="background-color: var(--bg-primary);">
            <div class="card-body">
              <!-- Document Header -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center gap-3">
                  <div class="document-icon bg-danger bg-opacity-10 rounded-3 p-3">
                    <i class="fas {{ getDocumentIcon(doc.documentType) }} text-danger fs-3"></i>
                  </div>
                  <div>
                    <h5 class="fw-bold mb-1" style="color: var(--text-primary);">
                      {{ doc.documentType.replace('_', ' ') }}
                    </h5>
                    <small class="text-muted">{{ doc.documentName }}</small>
                  </div>
                </div>
              </div>

              <!-- Document Status -->
              <div class="mb-3">
                <span class="badge bg-{{ getDocumentStatusColor(doc.verificationStatus || 'PENDING') }} fs-6">
                  <i class="fas fa-circle me-1"></i>{{ doc.verificationStatus || 'PENDING' }}
                </span>
              </div>

              <!-- Document Details -->
              <div class="mb-3">
                <div class="row g-2">
                  <div class="col-12">
                    <small class="text-muted d-block">Uploaded On</small>
                    <strong style="color: var(--text-primary);">{{ formatDate(doc.uploadedAt) }}</strong>
                  </div>
                  <div class="col-12" *ngIf="doc.verifiedBy">
                    <small class="text-muted d-block">Verified By</small>
                    <strong style="color: var(--text-primary);">{{ doc.verifiedBy }}</strong>
                  </div>
                  <div class="col-12" *ngIf="doc.verifiedAt">
                    <small class="text-muted d-block">Verified On</small>
                    <strong style="color: var(--text-primary);">{{ formatDate(doc.verifiedAt) }}</strong>
                  </div>
                  <div class="col-12" *ngIf="doc.remarks">
                    <small class="text-muted d-block">Remarks</small>
                    <strong style="color: var(--text-primary);">{{ doc.remarks }}</strong>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-primary btn-sm" 
                        (click)="viewDocument(doc)">
                  <i class="fas fa-eye me-1"></i>View
                </button>
                <button class="btn btn-sm" 
                        (click)="requestDocumentResubmission(doc)"
                        [disabled]="doc.verificationStatus === 'RESUBMISSION_REQUESTED' || resubmissionRequested.has(doc.documentId) || verdictSubmitted"
                        [class.btn-warning]="!resubmissionRequested.has(doc.documentId) && doc.verificationStatus !== 'RESUBMISSION_REQUESTED' && !verdictSubmitted"
                        [class.btn-secondary]="resubmissionRequested.has(doc.documentId) || doc.verificationStatus === 'RESUBMISSION_REQUESTED' || verdictSubmitted"
                        [title]="getResubmissionButtonMessage(doc.documentId)">
                  <i class="fas" 
                     [class.fa-redo]="!resubmissionRequested.has(doc.documentId) && doc.verificationStatus !== 'RESUBMISSION_REQUESTED' && !verdictSubmitted"
                     [class.fa-check-circle]="resubmissionRequested.has(doc.documentId) || doc.verificationStatus === 'RESUBMISSION_REQUESTED'"
                     [class.fa-lock]="verdictSubmitted"
                     class="me-1"></i>
                  {{ verdictSubmitted ? 'Locked' : (resubmissionRequested.has(doc.documentId) || doc.verificationStatus === 'RESUBMISSION_REQUESTED' ? 'Requested' : 'Resubmit') }}
                </button>
              </div>

              <!-- Already Processed Notice -->
              <div class="mt-2" *ngIf="doc.verificationStatus === 'RESUBMISSION_REQUESTED'">
                <small class="text-muted fst-italic">
                  <i class="fas fa-clock me-1"></i>Resubmission requested
                </small>
              </div>
              
              <!-- Current Session Resubmission Notice -->
              <div class="mt-2" *ngIf="resubmissionRequested.has(doc.documentId) && doc.verificationStatus !== 'RESUBMISSION_REQUESTED'">
                <small class="text-success fst-italic">
                  <i class="fas fa-check-circle me-1"></i>Resubmission requested in this session
                </small>
              </div>
              
              <!-- Verdict Submitted Notice -->
              <div class="mt-2" *ngIf="verdictSubmitted">
                <small class="text-info fst-italic">
                  <i class="fas fa-lock me-1"></i>Actions locked - verdict submitted
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="col-12" *ngIf="loanDocuments.length === 0 && !loading">
          <div class="text-center py-5">
            <i class="fas fa-folder-open text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No Documents Found</h4>
            <p class="text-muted">No documents have been uploaded for this loan application</p>
          </div>
        </div>
      </div>
    </div>

    <!-- External Fraud Data Tab -->
    <div *ngIf="activeTab === 'fraud-data'" class="tab-pane fade show active">
      <div *ngIf="!externalFraudData" class="text-center py-4">
        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
        <p class="text-muted">No external fraud data available.</p>
      </div>

      <div *ngIf="externalFraudData">
        <!-- Summary Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-university fa-2x text-primary mb-2"></i>
                <h4>{{ externalFraudData.bankRecords.totalAccounts }}</h4>
                <p class="text-muted mb-0">Bank Accounts</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-gavel fa-2x text-warning mb-2"></i>
                <h4>{{ externalFraudData.criminalRecords.totalCases }}</h4>
                <p class="text-muted mb-0">Criminal Cases</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-history fa-2x text-info mb-2"></i>
                <h4>{{ externalFraudData.loanHistory.totalLoans }}</h4>
                <p class="text-muted mb-0">Loan History</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-exclamation-triangle fa-2x" 
                   [class]="externalFraudData.riskAssessment.riskLevel === 'HIGH' ? 'text-danger' : 'text-success'"></i>
                <h4>{{ externalFraudData.riskAssessment.riskLevel }}</h4>
                <p class="text-muted mb-0">External Risk</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Bank Records -->
        <div class="card mb-4" *ngIf="externalFraudData.bankRecords.accounts.length > 0">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-university me-2"></i>Bank Records</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Bank Name</th>
                    <th>Account Type</th>
                    <th>Balance</th>
                    <th>Last Transaction</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let bank of externalFraudData.bankRecords.accounts">
                    <td>{{ bank.bankName }}</td>
                    <td>{{ bank.accountType }}</td>
                    <td>{{ formatCurrency(bank.balance) }}</td>
                    <td>{{ formatDate(bank.lastTransaction) }}</td>
                    <td>
                      <span [class]="bank.isActive ? 'badge bg-success' : 'badge bg-secondary'">
                        {{ bank.isActive ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Criminal Records -->
        <div class="card mb-4" *ngIf="externalFraudData.criminalRecords.cases.length > 0">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-gavel me-2"></i>Criminal Records</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Case Number</th>
                    <th>Case Type</th>
                    <th>Court</th>
                    <th>Status</th>
                    <th>Verdict Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let criminal of externalFraudData.criminalRecords.cases">
                    <td>{{ criminal.caseNumber }}</td>
                    <td>{{ criminal.caseType }}</td>
                    <td>{{ criminal.courtName }}</td>
                    <td>
                      <span [class]="criminal.status === 'CONVICTED' ? 'badge bg-danger' : 
                                     criminal.status === 'ACQUITTED' ? 'badge bg-success' : 
                                     criminal.status === 'OPEN' ? 'badge bg-warning' : 'badge bg-secondary'">
                        {{ criminal.status }}
                      </span>
                    </td>
                    <td>{{ criminal.verdictDate ? formatDate(criminal.verdictDate) : 'N/A' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Loan History -->
        <div class="card mb-4" *ngIf="externalFraudData.loanHistory.loans.length > 0">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Loan History</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Institution</th>
                    <th>Loan Type</th>
                    <th>Amount</th>
                    <th>Outstanding</th>
                    <th>Status</th>
                    <th>Default Flag</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let loan of externalFraudData.loanHistory.loans">
                    <td>{{ loan.institutionName }}</td>
                    <td>{{ loan.loanType }}</td>
                    <td>{{ formatCurrency(loan.loanAmount) }}</td>
                    <td>{{ formatCurrency(loan.outstandingBalance) }}</td>
                    <td>
                      <span [class]="loan.status === 'DEFAULTED' ? 'badge bg-danger' : 
                                     loan.status === 'ACTIVE' ? 'badge bg-success' : 'badge bg-secondary'">
                        {{ loan.status }}
                      </span>
                    </td>
                    <td>
                      <span [class]="loan.defaultFlag ? 'badge bg-danger' : 'badge bg-success'">
                        {{ loan.defaultFlag ? 'Yes' : 'No' }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Screening Results Tab -->
    <div *ngIf="activeTab === 'screening'" class="tab-pane fade show active">
      <div *ngIf="!enhancedScreeningData && !screeningResults" class="text-center py-4">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <p class="text-muted">Loading screening results...</p>
      </div>

      <div *ngIf="enhancedScreeningData">
        <!-- Risk Score Summary -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Risk Assessment Summary</h5>
            <button class="btn btn-outline-primary btn-sm" (click)="openScreeningDetailsModal()">
              <i class="fas fa-eye me-1"></i>View Full Details
            </button>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="text-center">
                  <div class="risk-score-circle mb-2" 
                       [class]="'risk-' + enhancedScreeningData.normalizedRiskScore.riskLevel.toLowerCase()">
                    <span class="risk-score-number">{{ enhancedScreeningData.normalizedRiskScore.finalScore | number:'1.0-1' }}</span>
                    <small class="risk-score-label">RISK SCORE</small>
                  </div>
                  <span class="badge bg-{{ getRiskLevelColor(enhancedScreeningData.normalizedRiskScore.riskLevel) }}">
                    {{ enhancedScreeningData.normalizedRiskScore.riskLevel }}
                  </span>
                </div>
              </div>
              <div class="col-md-9">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">Internal Scoring</h6>
                    <p class="mb-1">
                      <strong>Score:</strong> {{ enhancedScreeningData.scoringBreakdown.internalScoring.normalizedScore | number:'1.0-1' }}/100
                    </p>
                    <p class="mb-1">
                      <strong>Violations:</strong> {{ enhancedScreeningData.scoringBreakdown.internalScoring.violatedRulesCount }}
                    </p>
                    <p class="mb-0">
                      <strong>Risk Level:</strong> 
                      <span class="badge bg-{{ getRiskLevelColor(enhancedScreeningData.scoringBreakdown.internalScoring.riskLevel) }}">
                        {{ enhancedScreeningData.scoringBreakdown.internalScoring.riskLevel }}
                      </span>
                    </p>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">External Scoring</h6>
                    <p class="mb-1">
                      <strong>Score:</strong> {{ enhancedScreeningData.scoringBreakdown.externalScoring.normalizedScore | number:'1.0-1' }}/100
                    </p>
                    <p class="mb-1">
                      <strong>Violations:</strong> {{ enhancedScreeningData.scoringBreakdown.externalScoring.violatedRulesCount }}
                    </p>
                    <p class="mb-0">
                      <strong>Person Found:</strong> 
                      <span [class]="enhancedScreeningData.scoringBreakdown.externalScoring.personFound ? 'badge bg-warning' : 'badge bg-success'">
                        {{ enhancedScreeningData.scoringBreakdown.externalScoring.personFound ? 'Yes' : 'No' }}
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Severity Breakdown -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Violation Severity Breakdown</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="severity-stat">
                  <div class="severity-number text-danger">{{ enhancedScreeningData.scoringBreakdown.severityBreakdown.criticalCount }}</div>
                  <div class="severity-label">Critical</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="severity-stat">
                  <div class="severity-number text-warning">{{ enhancedScreeningData.scoringBreakdown.severityBreakdown.highCount }}</div>
                  <div class="severity-label">High</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="severity-stat">
                  <div class="severity-number text-info">{{ enhancedScreeningData.scoringBreakdown.severityBreakdown.mediumCount }}</div>
                  <div class="severity-label">Medium</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="severity-stat">
                  <div class="severity-number text-secondary">{{ enhancedScreeningData.scoringBreakdown.severityBreakdown.lowCount }}</div>
                  <div class="severity-label">Low</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Final Recommendation -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Final Recommendation</h5>
          </div>
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h4 class="mb-2">
                  <span class="badge bg-{{ enhancedScreeningData.finalRecommendation === 'APPROVE' ? 'success' : 
                                          enhancedScreeningData.finalRecommendation === 'REJECT' ? 'danger' : 'warning' }} fs-6">
                    {{ enhancedScreeningData.finalRecommendation }}
                  </span>
                </h4>
                <p class="text-muted mb-0">{{ enhancedScreeningData.normalizedRiskScore.scoreInterpretation }}</p>
              </div>
              <div class="col-md-4 text-end">
                <p class="mb-1"><strong>Total Violations:</strong> {{ enhancedScreeningData.scoringBreakdown.severityBreakdown.totalViolations }}</p>
                <p class="mb-0"><strong>Can Approve/Reject:</strong> 
                  <span [class]="enhancedScreeningData.canApproveReject ? 'badge bg-success' : 'badge bg-warning'">
                    {{ enhancedScreeningData.canApproveReject ? 'Yes' : 'No' }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fallback to Basic Screening Results -->
      <div *ngIf="!enhancedScreeningData && screeningResults">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          Enhanced screening data is not available. Showing basic screening results.
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Risk Correlation Analysis</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Compliance Risk Rating:</strong> 
                  <span class="badge bg-info">{{ screeningResults.complianceRiskRating }}/5</span>
                </p>
                <p><strong>Defaulter History:</strong> 
                  <span [class]="screeningResults.defaulterHistory ? 'badge bg-danger' : 'badge bg-success'">
                    {{ screeningResults.defaulterHistory ? 'Yes' : 'No' }}
                  </span>
                </p>
              </div>
              <div class="col-md-6">
                <p><strong>Recommendation:</strong></p>
                <p class="text-muted">{{ screeningResults.recommendation }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Transaction Anomalies -->
        <div class="card mb-4" *ngIf="screeningResults.transactionAnomalies?.length > 0">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Transaction Anomalies</h5>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item" *ngFor="let anomaly of screeningResults.transactionAnomalies">
                <i class="fas fa-warning text-warning me-2"></i>{{ anomaly }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Fraud Flags Tab -->
 
  </div>
</div>

<!-- Verdict Modal -->
<div class="modal fade" [class.show]="showVerdictModal" [style.display]="showVerdictModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showVerdictModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-gavel me-2"></i>Submit Compliance Verdict
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="verdictForm" (ngSubmit)="submitVerdict()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Recommendation *</label>
                <select class="form-select" formControlName="recommendation">
                  <option value="">Select recommendation</option>
                  <option value="RECOMMEND_APPROVE">Recommend Approve</option>
                  <option value="RECOMMEND_REJECT">Recommend Reject</option>
                  <option value="REQUEST_MORE_INFO">Request More Information</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Risk Assessment *</label>
                <select class="form-select" formControlName="riskAssessment">
                  <option value="">Select risk level</option>
                  <option value="LOW">Low Risk</option>
                  <option value="MEDIUM">Medium Risk</option>
                  <option value="HIGH">High Risk</option>
                  <option value="CRITICAL">Critical Risk</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Compliance Notes *</label>
            <textarea class="form-control" rows="4" formControlName="complianceNotes" 
                      placeholder="Provide detailed compliance assessment notes..."></textarea>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Recommended Action *</label>
            <textarea class="form-control" rows="3" formControlName="recommendedAction" 
                      placeholder="Specify the recommended action for the loan officer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="verdictSubmitting">Cancel</button>
          <button type="submit" class="btn btn-danger" 
                  [disabled]="verdictForm.invalid || verdictSubmitting || verdictSubmitted">
            <i class="fas" 
               [class.fa-gavel]="!verdictSubmitting"
               [class.fa-spinner]="verdictSubmitting"
               [class.fa-spin]="verdictSubmitting"
               class="me-2"></i>
            {{ verdictSubmitting ? 'Submitting Verdict...' : 'Submit Verdict' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Document Resubmission Modal -->
<div class="modal fade" [class.show]="showResubmissionModal" [style.display]="showResubmissionModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showResubmissionModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-redo me-2"></i>Request Document Resubmission
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="resubmissionForm" (ngSubmit)="submitResubmissionRequest()">
        <div class="modal-body">
          <div *ngIf="selectedDocument" class="alert alert-info">
            <strong>Document:</strong> {{ selectedDocument.documentType }} - {{ selectedDocument.documentName }}
          </div>
          
          <div class="mb-3">
            <label class="form-label">Reason for Resubmission *</label>
            <select class="form-select" formControlName="reason">
              <option value="">Select reason</option>
              <option value="POOR_QUALITY">Poor Image Quality</option>
              <option value="INCOMPLETE_INFO">Incomplete Information</option>
              <option value="EXPIRED_DOCUMENT">Expired Document</option>
              <option value="MISMATCH_DATA">Data Mismatch</option>
              <option value="SUSPICIOUS_CONTENT">Suspicious Content</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Instructions *</label>
            <textarea class="form-control" rows="4" formControlName="instructions" 
                      placeholder="Provide specific instructions for resubmission..."></textarea>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Priority</label>
            <select class="form-select" formControlName="priority">
              <option value="LOW">Low</option>
              <option value="MEDIUM">Medium</option>
              <option value="HIGH">High</option>
              <option value="URGENT">Urgent</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="resubmissionSubmitting">Cancel</button>
          <button type="submit" class="btn btn-warning" 
                  [disabled]="resubmissionForm.invalid || resubmissionSubmitting">
            <i class="fas" 
               [class.fa-redo]="!resubmissionSubmitting"
               [class.fa-spinner]="resubmissionSubmitting"
               [class.fa-spin]="resubmissionSubmitting"
               class="me-2"></i>
            {{ resubmissionSubmitting ? 'Sending Request...' : 'Request Resubmission' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Document Viewer Component -->
<app-document-viewer
  [document]="selectedDocument"
  [show]="showDocumentModal"
  [extractedData]="extractedData"
  [extracting]="extracting"
  [canExtract]="true"
  [canVerify]="true"
  themeColor="danger"
  (close)="closeDocumentModal()"
  (extract)="extractDocumentData($event)"
  (approve)="approveDocument($event)"
  (reject)="rejectDocument($event)">
</app-document-viewer>

<!-- Screening Details Modal -->
<div class="modal fade show d-block" *ngIf="showScreeningDetailsModal && enhancedScreeningData" 
     style="background-color: rgba(0,0,0,0.5);" 
     (click)="closeScreeningDetailsModal()">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" (click)="$event.stopPropagation()">
    <div class="modal-content" style="background-color: var(--bg-primary);">
      <!-- Modal Header -->
      <div class="modal-header border-bottom" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
        <h5 class="modal-title text-white fw-bold">
          <i class="fas fa-chart-line me-2"></i>Enhanced Screening Details
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeScreeningDetailsModal()"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4">
        <div class="row g-4">
          <!-- Left Column - Scoring Breakdown -->
          <div class="col-lg-6">
            <!-- Internal Scoring Details -->
            <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
              <div class="card-header border-0">
                <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
                  <i class="fas fa-home me-2 text-primary"></i>Internal Scoring Details
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-6">
                    <small class="text-muted">Raw Score</small>
                    <p class="fw-bold mb-0">{{ enhancedScreeningData.scoringBreakdown.internalScoring.rawScore }} / {{ enhancedScreeningData.scoringBreakdown.internalScoring.maxPossibleScore }}</p>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Normalized Score</small>
                    <p class="fw-bold mb-0">{{ enhancedScreeningData.scoringBreakdown.internalScoring.normalizedScore | number:'1.0-1' }}/100</p>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Risk Level</small>
                    <p class="mb-0">
                      <span class="badge bg-{{ getRiskLevelColor(enhancedScreeningData.scoringBreakdown.internalScoring.riskLevel) }}">
                        {{ enhancedScreeningData.scoringBreakdown.internalScoring.riskLevel }}
                      </span>
                    </p>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Violated Rules</small>
                    <p class="fw-bold mb-0">{{ enhancedScreeningData.scoringBreakdown.internalScoring.violatedRulesCount }}</p>
                  </div>
                  <div class="col-12">
                    <small class="text-muted">Categories</small>
                    <div class="mt-1">
                      <span class="badge bg-info me-1" *ngFor="let category of enhancedScreeningData.scoringBreakdown.internalScoring.categories">
                        {{ category }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- External Scoring Details -->
            <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
              <div class="card-header border-0">
                <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
                  <i class="fas fa-globe me-2 text-warning"></i>External Scoring Details
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-6">
                    <small class="text-muted">Raw Score</small>
                    <p class="fw-bold mb-0">{{ enhancedScreeningData.scoringBreakdown.externalScoring.rawScore }} / {{ enhancedScreeningData.scoringBreakdown.externalScoring.maxPossibleScore }}</p>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Normalized Score</small>
                    <p class="fw-bold mb-0">{{ enhancedScreeningData.scoringBreakdown.externalScoring.normalizedScore | number:'1.0-1' }}/100</p>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Risk Level</small>
                    <p class="mb-0">
                      <span class="badge bg-{{ getRiskLevelColor(enhancedScreeningData.scoringBreakdown.externalScoring.riskLevel) }}">
                        {{ enhancedScreeningData.scoringBreakdown.externalScoring.riskLevel }}
                      </span>
                    </p>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Person Found</small>
                    <p class="mb-0">
                      <span [class]="enhancedScreeningData.scoringBreakdown.externalScoring.personFound ? 'badge bg-warning' : 'badge bg-success'">
                        {{ enhancedScreeningData.scoringBreakdown.externalScoring.personFound ? 'Yes' : 'No' }}
                      </span>
                    </p>
                  </div>
                  <div class="col-12">
                    <small class="text-muted">Categories</small>
                    <div class="mt-1">
                      <span class="badge bg-warning me-1" *ngFor="let category of enhancedScreeningData.scoringBreakdown.externalScoring.categories">
                        {{ category }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Rule Violations -->
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm" style="background-color: var(--bg-secondary);">
              <div class="card-header border-0">
                <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
                  <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Rule Violations ({{ enhancedScreeningData.ruleViolations.length }})
                </h6>
              </div>
              <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div class="violation-item mb-3 p-3 rounded" 
                     style="background-color: var(--bg-primary);" 
                     *ngFor="let violation of enhancedScreeningData.ruleViolations">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-1" style="color: var(--text-primary);">{{ violation.ruleName }}</h6>
                      <small class="text-muted">{{ violation.ruleCode }} â€¢ {{ violation.category }}</small>
                    </div>
                    <div class="text-end">
                      <span class="badge bg-{{ getSeverityColor(violation.severity) }}">{{ violation.severity }}</span>
                      <div class="mt-1">
                        <small class="text-muted">{{ violation.points }} pts</small>
                      </div>
                    </div>
                  </div>
                  <p class="mb-2 small" style="color: var(--text-primary);">{{ violation.description }}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-{{ violation.source === 'INTERNAL' ? 'primary' : 'warning' }}">
                      {{ violation.source }}
                    </span>
                    <small class="text-muted">{{ formatDate(violation.detectedAt) }}</small>
                  </div>
                </div>
                
                <div *ngIf="enhancedScreeningData.ruleViolations.length === 0" class="text-center py-4">
                  <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                  <p class="text-muted">No rule violations detected</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Methodology Section -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm" style="background-color: var(--bg-secondary);">
              <div class="card-header border-0">
                <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
                  <i class="fas fa-calculator me-2 text-info"></i>Scoring Methodology
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <p class="mb-2"><strong>Normalization Method:</strong></p>
                    <p class="text-muted small">{{ enhancedScreeningData.scoringBreakdown.normalizationMethod }}</p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-2"><strong>Combination Formula:</strong></p>
                    <p class="text-muted small">{{ enhancedScreeningData.scoringBreakdown.combinationFormula }}</p>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <p class="mb-2"><strong>Severity Score Contribution:</strong></p>
                    <p class="text-muted">{{ enhancedScreeningData.scoringBreakdown.severityBreakdown.severityScore | number:'1.0-1' }}/100</p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-2"><strong>Points Score Contribution:</strong></p>
                    <p class="text-muted">{{ enhancedScreeningData.scoringBreakdown.severityBreakdown.pointsScore | number:'1.0-1' }}/40</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" (click)="closeScreeningDetailsModal()">
          <i class="fas fa-times me-2"></i>Close
        </button>
        <button type="button" class="btn btn-primary" (click)="closeScreeningDetailsModal(); setActiveTab('flags')">
          <i class="fas fa-flag me-2"></i>View Fraud Flags
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showVerdictModal || showResubmissionModal || showDocumentModal || showScreeningDetailsModal" (click)="closeModal()"></div>
