<!-- Loan Review Content -->

<!-- Loading State -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-muted">Loading loan details...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading && !success" class="container-fluid py-4">
  <div class="alert alert-danger">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
</div>

<!-- Success State -->
<div *ngIf="success" class="container-fluid py-4">
  <div class="alert alert-success">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid px-4 py-4" *ngIf="!loading && loan">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 animate-fade-in">
    <div>
      <button class="btn btn-outline-secondary btn-sm mb-2" (click)="goBack()">
        <i class="fas fa-arrow-left me-2"></i>Back to Assigned Loans
      </button>
      <h2 class="h3 fw-bold mb-1" style="color: var(--text-primary);">
        <i class="fas fa-search me-2 text-primary"></i>Loan Review & Screening
      </h2>
      <p class="text-muted mb-0">Assignment ID: #{{ assignmentId }}</p>
    </div>
    <span class="badge bg-{{ getStatusColor(loan.status) }} fs-6">{{ loan.status }}</span>
  </div>

  <div class="row g-4">
    <!-- Left Column - Applicant & Loan Details -->
    <div class="col-lg-8">
      
      <!-- Applicant Information -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.1s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-user-circle me-2 text-primary"></i>Applicant Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="info-item">
                <label class="text-muted small mb-1">Applicant Name</label>
                <div class="d-flex align-items-center">
                  <div class="avatar-md bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                    <i class="fas fa-user text-primary fs-4"></i>
                  </div>
                  <div>
                    <h5 class="fw-bold mb-0" style="color: var(--text-primary);">{{ loan.applicantName }}</h5>
                    <small class="text-muted">ID: {{ loan.applicantId }}</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <label class="text-muted small mb-1">Loan ID</label>
                <h5 class="fw-bold" style="color: var(--text-primary);">#{{ loan.loanId }}</h5>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loan Details -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.2s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-file-alt me-2 text-primary"></i>Loan Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-4">
              <div class="info-item">
                <label class="text-muted small mb-1">
                  <i class="fas fa-tag me-1"></i>Loan Type
                </label>
                <h6 class="fw-semibold" style="color: var(--text-primary);">{{ loan.loanType }}</h6>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="text-muted small mb-1">
                  <i class="fas fa-rupee-sign me-1"></i>Loan Amount
                </label>
                <h6 class="fw-semibold text-success">{{ formatCurrency(loan.loanAmount) }}</h6>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="text-muted small mb-1">
                  <i class="fas fa-calendar me-1"></i>Assigned Date
                </label>
                <h6 class="fw-semibold" style="color: var(--text-primary);">{{ formatDate(loan.assignedAt) }}</h6>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Officer Remarks -->
      <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.3s; background-color: var(--bg-primary);" *ngIf="loan.remarks">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-comment-alt me-2 text-primary"></i>Previous Remarks
          </h5>
        </div>
        <div class="card-body">
          <p class="mb-0" style="color: var(--text-primary);">{{ loan.remarks }}</p>
        </div>
      </div>

      <!-- Documents Section -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.4s; background-color: var(--bg-primary);">
        <div class="card-header border-0 d-flex justify-content-between align-items-center" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-file-alt me-2 text-primary"></i>Documents ({{ documents.length }})
          </h5>
          <button class="btn btn-sm btn-outline-primary" (click)="openDocumentsModal()">
            <i class="fas fa-eye me-1"></i>View All
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="documents.length === 0" class="text-center text-muted py-3">
            <i class="fas fa-folder-open fa-2x mb-2"></i>
            <p>No documents uploaded yet</p>
          </div>
          <div *ngIf="documents.length > 0" class="row g-3">
            <div *ngFor="let doc of documents.slice(0, 3)" class="col-md-4">
              <div class="document-item p-3 border rounded">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <small class="fw-semibold" style="color: var(--text-primary);">{{ formatDocumentType(doc.documentType) }}</small>
                  </div>
                  <span [class]="getDocumentStatusClass(doc.verificationStatus)">{{ doc.verificationStatus }}</span>
                </div>
                <small class="text-muted d-block">{{ doc.documentName }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fraud Check Results -->
      <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.5s; background-color: var(--bg-primary);" *ngIf="fraudCheckResult">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-shield-alt me-2 text-danger"></i>Fraud Screening Results
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="text-muted small mb-1">Risk Level</label>
              <h6 class="fw-semibold">
                <span class="badge bg-{{ getRiskColor(fraudCheckResult.riskLevel) }}">{{ fraudCheckResult.riskLevel }}</span>
              </h6>
            </div>
            <div class="col-md-6">
              <label class="text-muted small mb-1">Risk Score</label>
              <h6 class="fw-semibold" style="color: var(--text-primary);">{{ fraudCheckResult.riskScore }}/100</h6>
            </div>
            <div class="col-12" *ngIf="fraudCheckResult.fraudTags && fraudCheckResult.fraudTags.length > 0">
              <label class="text-muted small mb-2">Fraud Tags</label>
              <div class="d-flex flex-wrap gap-2">
                <span *ngFor="let tag of fraudCheckResult.fraudTags" class="badge bg-danger">{{ tag }}</span>
              </div>
            </div>
            <div class="col-12" *ngIf="fraudCheckResult.apiRemarks">
              <label class="text-muted small mb-1">API Remarks</label>
              <p class="mb-0" style="color: var(--text-primary);">{{ fraudCheckResult.apiRemarks }}</p>
            </div>
            <div class="col-12">
              <small class="text-muted">Checked at: {{ formatDate(fraudCheckResult.checkedAt) }}</small>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Column - Risk Assessment & Actions -->
    <div class="col-lg-4">
      
      <!-- Risk Assessment -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.4s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-line me-2 text-primary"></i>Risk Assessment
          </h5>
        </div>
        <div class="card-body text-center">
          <!-- Risk Score Circle -->
          <div class="risk-circle mx-auto mb-3" [class]="'risk-' + loan.riskLevel.toLowerCase()">
            <div class="risk-score">
              <h2 class="fw-bold mb-0">{{ loan.riskScore }}</h2>
              <small>/ 100</small>
            </div>
          </div>
          
          <!-- Risk Level Badge -->
          <h4 class="mb-3">
            <span class="badge bg-{{ getRiskColor(loan.riskLevel) }} fs-5">
              {{ loan.riskLevel }} RISK
            </span>
          </h4>

          <!-- Risk Progress Bar -->
          <div class="progress" style="height: 12px;">
            <div class="progress-bar {{ getRiskProgressColor(loan.riskScore) }} progress-bar-striped progress-bar-animated" 
                 [style.width.%]="getRiskPercentage(loan.riskScore)"
                 role="progressbar">
            </div>
          </div>
          <small class="text-muted d-block mt-2">Risk Score: {{ loan.riskScore }}%</small>

          <!-- Can Approve/Reject Indicator -->
          <div class="mt-3 p-3 rounded" [class]="loan.canApproveReject ? 'bg-success bg-opacity-10' : 'bg-warning bg-opacity-10'">
            <i class="fas" [class.fa-check-circle]="loan.canApproveReject" [class.fa-exclamation-triangle]="!loan.canApproveReject"
               [class.text-success]="loan.canApproveReject" [class.text-warning]="!loan.canApproveReject"></i>
            <small class="d-block mt-2 fw-semibold" [class.text-success]="loan.canApproveReject" [class.text-warning]="!loan.canApproveReject">
              {{ loan.canApproveReject ? 'You can approve/reject this loan' : 'Requires escalation to compliance' }}
            </small>
          </div>

          <!-- Score Interpretation -->
          <div class="mt-3 p-3 rounded bg-info bg-opacity-10" *ngIf="enhancedLoan">
            <small class="text-muted d-block mb-1"><i class="fas fa-info-circle me-1"></i>Score Interpretation</small>
            <small class="d-block" style="color: var(--text-primary);">{{ enhancedLoan.normalizedRiskScore.scoreInterpretation }}</small>
          </div>
        </div>
      </div>

      <!-- Scoring Breakdown (Enhanced) -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.45s; background-color: var(--bg-primary);" *ngIf="enhancedLoan">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-calculator me-2 text-primary"></i>Scoring Breakdown
          </h5>
        </div>
        <div class="card-body">
          <!-- Final Score -->
          <div class="mb-3 p-3 rounded" style="background-color: var(--bg-secondary);">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-semibold" style="color: var(--text-primary);">Final Score</span>
              <span class="badge bg-{{ getRiskColor(enhancedLoan.normalizedRiskScore.riskLevel) }} fs-6">
                {{ enhancedLoan.normalizedRiskScore.finalScore.toFixed(1) }}%
              </span>
            </div>
          </div>

          <!-- Internal Scoring -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted"><i class="fas fa-building me-1"></i>Internal Scoring</small>
              <span class="badge bg-secondary">{{ enhancedLoan.scoringBreakdown.internalScoring.normalizedScore.toFixed(1) }}%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-info" 
                   [style.width.%]="enhancedLoan.scoringBreakdown.internalScoring.normalizedScore"
                   role="progressbar">
              </div>
            </div>
            <small class="text-muted d-block mt-1">
              {{ enhancedLoan.scoringBreakdown.internalScoring.rawScore }} / {{ enhancedLoan.scoringBreakdown.internalScoring.maxPossibleScore }} points
              ({{ enhancedLoan.scoringBreakdown.internalScoring.violatedRulesCount }} violations)
            </small>
          </div>

          <!-- External Scoring -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted"><i class="fas fa-globe me-1"></i>External Scoring</small>
              <span class="badge bg-secondary">{{ enhancedLoan.scoringBreakdown.externalScoring.normalizedScore.toFixed(1) }}%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-warning" 
                   [style.width.%]="enhancedLoan.scoringBreakdown.externalScoring.normalizedScore"
                   role="progressbar">
              </div>
            </div>
            <small class="text-muted d-block mt-1">
              {{ enhancedLoan.scoringBreakdown.externalScoring.rawScore }} / {{ enhancedLoan.scoringBreakdown.externalScoring.maxPossibleScore }} points
              ({{ enhancedLoan.scoringBreakdown.externalScoring.violatedRulesCount }} violations)
            </small>
          </div>

          <!-- Recommendation -->
          <div class="mt-3 p-2 rounded text-center" 
               [class.bg-success]="enhancedLoan.finalRecommendation === 'APPROVE'"
               [class.bg-warning]="enhancedLoan.finalRecommendation === 'REVIEW'"
               [class.bg-danger]="enhancedLoan.finalRecommendation === 'REJECT'"
               style="opacity: 0.1;">
            <small class="fw-semibold" style="color: var(--text-primary);">
              Recommendation: {{ enhancedLoan.finalRecommendation }}
            </small>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.5s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-tasks me-2 text-primary"></i>Screening Actions
          </h5>
        </div>
        <div class="card-body d-grid gap-2">
          <button class="btn btn-info btn-sm" 
                  (click)="openFraudCheckModal()"
                  [disabled]="fraudCheckTriggered || loan.status !== 'ASSIGNED' && loan.status !== 'PENDING'">
            <i class="fas fa-shield-alt me-2"></i>{{ fraudCheckTriggered ? 'Fraud Check Completed' : 'Trigger Fraud Screening' }}
          </button>
          
          <button class="btn btn-outline-warning btn-sm" 
                  (click)="openResubmissionModal()"
                  [disabled]="loan.status !== 'ASSIGNED' && loan.status !== 'PENDING'">
            <i class="fas fa-redo me-2"></i>Request Document Resubmission
          </button>
        </div>
      </div>

      <!-- Decision Actions -->
      <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.6s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-gavel me-2 text-primary"></i>Final Decision
          </h5>
        </div>
        <div class="card-body d-grid gap-3">
          <button class="btn btn-success btn-lg" 
                  (click)="openActionModal('APPROVE')"
                  [disabled]="!loan.canApproveReject || (loan.status !== 'ASSIGNED' && loan.status !== 'PENDING' && loan.status !== 'IN_PROGRESS')">
            <i class="fas fa-check-circle me-2"></i>Approve Loan
          </button>
          
          <button class="btn btn-danger btn-lg" 
                  (click)="openActionModal('REJECT')"
                  [disabled]="!loan.canApproveReject || (loan.status !== 'ASSIGNED' && loan.status !== 'PENDING' && loan.status !== 'IN_PROGRESS')">
            <i class="fas fa-times-circle me-2"></i>Reject Loan
          </button>
          
          <button class="btn btn-warning btn-lg" 
                  (click)="openActionModal('ESCALATE_TO_COMPLIANCE')"
                  [disabled]="loan.status !== 'ASSIGNED' && loan.status !== 'PENDING' && loan.status !== 'IN_PROGRESS'">
            <i class="fas fa-arrow-up me-2"></i>Escalate to Compliance
          </button>

          <button class="btn btn-outline-secondary btn-lg" (click)="goBack()">
            <i class="fas fa-arrow-left me-2"></i>Back to List
          </button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Action Confirmation Modal -->
<div class="modal fade" [class.show]="showActionModal" [style.display]="showActionModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: var(--bg-primary); border-color: var(--border-color);">
      <div class="modal-header" style="border-color: var(--border-color);">
        <h5 class="modal-title" style="color: var(--text-primary);">
          <i class="fas" 
             [class.fa-check-circle]="actionType === 'APPROVE'"
             [class.fa-times-circle]="actionType === 'REJECT'"
             [class.fa-arrow-up]="actionType === 'ESCALATE_TO_COMPLIANCE'"
             [class.text-success]="actionType === 'APPROVE'"
             [class.text-danger]="actionType === 'REJECT'"
             [class.text-warning]="actionType === 'ESCALATE_TO_COMPLIANCE'"></i>
          {{ actionType === 'APPROVE' ? 'Approve Loan' : actionType === 'REJECT' ? 'Reject Loan' : 'Escalate to Compliance' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeActionModal()" [disabled]="processing"></button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-primary);">
          {{ actionType === 'APPROVE' ? 'Are you sure you want to approve this loan application?' : 
             actionType === 'REJECT' ? 'Please provide a reason for rejecting this loan application:' : 
             'Escalate this loan to a compliance officer for further review.' }}
        </p>

        <!-- Rejection Reason (only for REJECT) -->
        <div class="mb-3" *ngIf="actionType === 'REJECT'">
          <label class="form-label fw-semibold" style="color: var(--text-primary);">Rejection Reason *</label>
          <textarea class="form-control" rows="3" 
                    [(ngModel)]="rejectionReason"
                    placeholder="Provide detailed reason for rejection..."
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
        </div>

        <!-- Remarks (optional for all) -->
        <div class="mb-3">
          <label class="form-label fw-semibold" style="color: var(--text-primary);">Remarks (Optional)</label>
          <textarea class="form-control" rows="3" 
                    [(ngModel)]="remarks"
                    placeholder="Add any additional comments..."
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
        </div>
      </div>
      <div class="modal-footer" style="border-color: var(--border-color);">
        <button type="button" class="btn btn-secondary" (click)="closeActionModal()" [disabled]="processing">
          Cancel
        </button>
        <button type="button" 
                class="btn"
                [class.btn-success]="actionType === 'APPROVE'"
                [class.btn-danger]="actionType === 'REJECT'"
                [class.btn-warning]="actionType === 'ESCALATE_TO_COMPLIANCE'"
                (click)="confirmAction()" 
                [disabled]="processing || (actionType === 'REJECT' && !rejectionReason)">
          <span *ngIf="processing" class="spinner-border spinner-border-sm me-2"></span>
          {{ processing ? 'Processing...' : 'Confirm' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showActionModal" *ngIf="showActionModal"></div>

<!-- Documents Modal -->
<div class="modal fade" [class.show]="showDocumentsModal" [style.display]="showDocumentsModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" style="background-color: var(--bg-primary); border-color: var(--border-color);">
      <div class="modal-header" style="border-color: var(--border-color);">
        <h5 class="modal-title" style="color: var(--text-primary);">
          <i class="fas fa-file-alt me-2 text-primary"></i>Document Verification
        </h5>
        <button type="button" class="btn-close" (click)="closeDocumentsModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="documents.length === 0" class="text-center text-muted py-5">
          <i class="fas fa-folder-open fa-3x mb-3"></i>
          <p>No documents available for verification</p>
        </div>
        <div *ngFor="let doc of documents" class="card mb-3" style="background-color: var(--bg-secondary);">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h6 class="fw-semibold mb-1" style="color: var(--text-primary);">
                  <i class="fas fa-file-pdf text-danger me-2"></i>{{ formatDocumentType(doc.documentType) }}
                </h6>
                <small class="text-muted">{{ doc.documentName }}</small>
                <div class="mt-2">
                  <span [class]="getDocumentStatusClass(doc.verificationStatus)">{{ doc.verificationStatus }}</span>
                  <small class="text-muted ms-2">Uploaded: {{ formatDate(doc.uploadedAt) }}</small>
                </div>
              </div>
              <div class="col-md-6 text-end">
                <a [href]="doc.documentUrl" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                  <i class="fas fa-eye me-1"></i>View
                </a>
                <button class="btn btn-sm btn-success me-2" 
                        (click)="verifyDocument(doc, 'VERIFIED')"
                        [disabled]="doc.verificationStatus === 'VERIFIED' || processing">
                  <i class="fas fa-check me-1"></i>Verify
                </button>
                <button class="btn btn-sm btn-danger" 
                        (click)="verifyDocument(doc, 'REJECTED')"
                        [disabled]="doc.verificationStatus === 'REJECTED' || processing">
                  <i class="fas fa-times me-1"></i>Reject
                </button>
              </div>
            </div>
            <div class="mt-3" *ngIf="doc.remarks">
              <small class="text-muted">Remarks: {{ doc.remarks }}</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="border-color: var(--border-color);">
        <button type="button" class="btn btn-secondary" (click)="closeDocumentsModal()">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showDocumentsModal" *ngIf="showDocumentsModal"></div>

<!-- Fraud Check Modal -->
<div class="modal fade" [class.show]="showFraudCheckModal" [style.display]="showFraudCheckModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: var(--bg-primary); border-color: var(--border-color);">
      <div class="modal-header" style="border-color: var(--border-color);">
        <h5 class="modal-title" style="color: var(--text-primary);">
          <i class="fas fa-shield-alt me-2 text-danger"></i>Trigger Fraud Screening
        </h5>
        <button type="button" class="btn-close" (click)="closeFraudCheckModal()" [disabled]="fraudCheckLoading"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          This will send applicant identifiers (PAN, Aadhaar, phone, email) to the External Authority API for fraud screening.
        </div>
        <p style="color: var(--text-primary);">Are you sure you want to trigger fraud screening for this application?</p>
        <ul class="text-muted small">
          <li>Applicant: <strong>{{ loan?.applicantName }}</strong></li>
          <li>Loan ID: <strong>#{{ loan?.loanId }}</strong></li>
          <li>Loan Amount: <strong>{{ formatCurrency(loan?.loanAmount || 0) }}</strong></li>
        </ul>
      </div>
      <div class="modal-footer" style="border-color: var(--border-color);">
        <button type="button" class="btn btn-secondary" (click)="closeFraudCheckModal()" [disabled]="fraudCheckLoading">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="triggerFraudCheck()" [disabled]="fraudCheckLoading">
          <span *ngIf="fraudCheckLoading" class="spinner-border spinner-border-sm me-2"></span>
          {{ fraudCheckLoading ? 'Processing...' : 'Trigger Fraud Check' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showFraudCheckModal" *ngIf="showFraudCheckModal"></div>

<!-- Document Resubmission Modal -->
<div class="modal fade" [class.show]="showResubmissionModal" [style.display]="showResubmissionModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: var(--bg-primary); border-color: var(--border-color);">
      <div class="modal-header" style="border-color: var(--border-color);">
        <h5 class="modal-title" style="color: var(--text-primary);">
          <i class="fas fa-redo me-2 text-warning"></i>Request Document Resubmission
        </h5>
        <button type="button" class="btn-close" (click)="closeResubmissionModal()" [disabled]="processing"></button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-primary);">Select documents that need to be resubmitted:</p>
        
        <div class="mb-3">
          <label class="form-label fw-semibold" style="color: var(--text-primary);">Document Types *</label>
          <div class="row g-2">
            <div *ngFor="let docType of availableDocumentTypes" class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       [id]="'doc-' + docType"
                       [checked]="selectedDocumentTypes.includes(docType)"
                       (change)="toggleDocumentType(docType)">
                <label class="form-check-label" [for]="'doc-' + docType" style="color: var(--text-primary);">
                  {{ formatDocumentType(docType) }}
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold" style="color: var(--text-primary);">Reason for Resubmission *</label>
          <textarea class="form-control" rows="3" 
                    [(ngModel)]="resubmissionReason"
                    placeholder="Explain why these documents need to be resubmitted..."
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
        </div>

        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          The applicant will receive an email alert to resubmit the selected documents.
        </div>
      </div>
      <div class="modal-footer" style="border-color: var(--border-color);">
        <button type="button" class="btn btn-secondary" (click)="closeResubmissionModal()" [disabled]="processing">
          Cancel
        </button>
        <button type="button" class="btn btn-warning" 
                (click)="requestResubmission()" 
                [disabled]="processing || selectedDocumentTypes.length === 0 || !resubmissionReason">
          <span *ngIf="processing" class="spinner-border spinner-border-sm me-2"></span>
          {{ processing ? 'Sending...' : 'Send Request' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showResubmissionModal" *ngIf="showResubmissionModal"></div>
