<!-- Loan Review Content -->

<!-- Loading State -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-muted">Loading loan details...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading && !success" class="container-fluid py-4">
  <div class="alert alert-danger">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
  </div>
</div>

<!-- Success State -->
<div *ngIf="success" class="container-fluid py-4">
  <div class="alert alert-success">
    <i class="fas fa-check-circle me-2"></i>{{ success }}
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid px-4 py-4" *ngIf="!loading && loan">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 animate-fade-in">
    <div>
      <button class="btn btn-outline-secondary btn-sm mb-2" (click)="goBack()">
        <i class="fas fa-arrow-left me-2"></i>Back to Assigned Loans
      </button>
      <h2 class="h3 fw-bold mb-1" style="color: var(--text-primary);">
        <i class="fas fa-search me-2 text-primary"></i>Loan Review & Screening
      </h2>
      <p class="text-muted mb-0">Assignment ID: #{{ assignmentId }}</p>
    </div>
    <span class="badge bg-{{ getStatusColor(loan.status) }} fs-6">{{ loan.status }}</span>
  </div>

  <div class="row g-4">
    <!-- Left Column - Applicant & Loan Details -->
    <div class="col-lg-8">
      
      <!-- Applicant Information -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.1s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-user-circle me-2 text-primary"></i>Applicant Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="info-item">
                <label class="text-muted small mb-1">Applicant Name</label>
                <div class="d-flex align-items-center">
                  <div class="avatar-md bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                    <i class="fas fa-user text-primary fs-4"></i>
                  </div>
                  <div>
                    <h5 class="fw-bold mb-0" style="color: var(--text-primary);">{{ loan.applicantName }}</h5>
                    <small class="text-muted">ID: {{ loan.applicantId }}</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <label class="text-muted small mb-1">Loan ID</label>
                <h5 class="fw-bold" style="color: var(--text-primary);">#{{ loan.loanId }}</h5>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loan Details -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.2s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-file-alt me-2 text-primary"></i>Loan Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-4">
              <div class="info-item">
                <label class="text-muted small mb-1">
                  <i class="fas fa-tag me-1"></i>Loan Type
                </label>
                <h6 class="fw-semibold" style="color: var(--text-primary);">{{ loan.loanType }}</h6>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="text-muted small mb-1">
                  <i class="fas fa-rupee-sign me-1"></i>Loan Amount
                </label>
                <h6 class="fw-semibold text-success">{{ formatCurrency(loan.loanAmount) }}</h6>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="text-muted small mb-1">
                  <i class="fas fa-calendar me-1"></i>Assigned Date
                </label>
                <h6 class="fw-semibold" style="color: var(--text-primary);">{{ formatDate(loan.assignedAt) }}</h6>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Officer Remarks -->
      <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.3s; background-color: var(--bg-primary);" *ngIf="loan.remarks">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-comment-alt me-2 text-primary"></i>Previous Remarks
          </h5>
        </div>
        <div class="card-body">
          <p class="mb-0" style="color: var(--text-primary);">{{ loan.remarks }}</p>
        </div>
      </div>

    </div>

    <!-- Right Column - Risk Assessment & Actions -->
    <div class="col-lg-4">
      
      <!-- Risk Assessment -->
      <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.4s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-line me-2 text-primary"></i>Risk Assessment
          </h5>
        </div>
        <div class="card-body text-center">
          <!-- Risk Score Circle -->
          <div class="risk-circle mx-auto mb-3" [class]="'risk-' + loan.riskLevel.toLowerCase()">
            <div class="risk-score">
              <h2 class="fw-bold mb-0">{{ loan.riskScore }}</h2>
              <small>/ 100</small>
            </div>
          </div>
          
          <!-- Risk Level Badge -->
          <h4 class="mb-3">
            <span class="badge bg-{{ getRiskColor(loan.riskLevel) }} fs-5">
              {{ loan.riskLevel }} RISK
            </span>
          </h4>

          <!-- Risk Progress Bar -->
          <div class="progress" style="height: 12px;">
            <div class="progress-bar {{ getRiskProgressColor(loan.riskScore) }} progress-bar-striped progress-bar-animated" 
                 [style.width.%]="getRiskPercentage(loan.riskScore)"
                 role="progressbar">
            </div>
          </div>
          <small class="text-muted d-block mt-2">Risk Score: {{ loan.riskScore }}%</small>

          <!-- Can Approve/Reject Indicator -->
          <div class="mt-3 p-3 rounded" [class]="loan.canApproveReject ? 'bg-success bg-opacity-10' : 'bg-warning bg-opacity-10'">
            <i class="fas" [class.fa-check-circle]="loan.canApproveReject" [class.fa-exclamation-triangle]="!loan.canApproveReject"
               [class.text-success]="loan.canApproveReject" [class.text-warning]="!loan.canApproveReject"></i>
            <small class="d-block mt-2 fw-semibold" [class.text-success]="loan.canApproveReject" [class.text-warning]="!loan.canApproveReject">
              {{ loan.canApproveReject ? 'You can approve/reject this loan' : 'Requires escalation to compliance' }}
            </small>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.5s; background-color: var(--bg-primary);">
        <div class="card-header border-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-tasks me-2 text-primary"></i>Actions
          </h5>
        </div>
        <div class="card-body d-grid gap-3">
          <button class="btn btn-success btn-lg" 
                  (click)="openActionModal('APPROVE')"
                  [disabled]="!loan.canApproveReject || loan.status !== 'ASSIGNED' && loan.status !== 'PENDING'">
            <i class="fas fa-check-circle me-2"></i>Approve Loan
          </button>
          
          <button class="btn btn-danger btn-lg" 
                  (click)="openActionModal('REJECT')"
                  [disabled]="!loan.canApproveReject || loan.status !== 'ASSIGNED' && loan.status !== 'PENDING'">
            <i class="fas fa-times-circle me-2"></i>Reject Loan
          </button>
          
          <button class="btn btn-warning btn-lg" 
                  (click)="openActionModal('ESCALATE_TO_COMPLIANCE')"
                  [disabled]="loan.status !== 'ASSIGNED' && loan.status !== 'PENDING'">
            <i class="fas fa-arrow-up me-2"></i>Escalate to Compliance
          </button>

          <button class="btn btn-outline-secondary btn-lg" (click)="goBack()">
            <i class="fas fa-arrow-left me-2"></i>Back to List
          </button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Action Confirmation Modal -->
<div class="modal fade" [class.show]="showActionModal" [style.display]="showActionModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: var(--bg-primary); border-color: var(--border-color);">
      <div class="modal-header" style="border-color: var(--border-color);">
        <h5 class="modal-title" style="color: var(--text-primary);">
          <i class="fas" 
             [class.fa-check-circle]="actionType === 'APPROVE'"
             [class.fa-times-circle]="actionType === 'REJECT'"
             [class.fa-arrow-up]="actionType === 'ESCALATE_TO_COMPLIANCE'"
             [class.text-success]="actionType === 'APPROVE'"
             [class.text-danger]="actionType === 'REJECT'"
             [class.text-warning]="actionType === 'ESCALATE_TO_COMPLIANCE'"></i>
          {{ actionType === 'APPROVE' ? 'Approve Loan' : actionType === 'REJECT' ? 'Reject Loan' : 'Escalate to Compliance' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeActionModal()" [disabled]="processing"></button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-primary);">
          {{ actionType === 'APPROVE' ? 'Are you sure you want to approve this loan application?' : 
             actionType === 'REJECT' ? 'Please provide a reason for rejecting this loan application:' : 
             'Escalate this loan to a compliance officer for further review.' }}
        </p>

        <!-- Rejection Reason (only for REJECT) -->
        <div class="mb-3" *ngIf="actionType === 'REJECT'">
          <label class="form-label fw-semibold" style="color: var(--text-primary);">Rejection Reason *</label>
          <textarea class="form-control" rows="3" 
                    [(ngModel)]="rejectionReason"
                    placeholder="Provide detailed reason for rejection..."
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
        </div>

        <!-- Remarks (optional for all) -->
        <div class="mb-3">
          <label class="form-label fw-semibold" style="color: var(--text-primary);">Remarks (Optional)</label>
          <textarea class="form-control" rows="3" 
                    [(ngModel)]="remarks"
                    placeholder="Add any additional comments..."
                    style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
        </div>
      </div>
      <div class="modal-footer" style="border-color: var(--border-color);">
        <button type="button" class="btn btn-secondary" (click)="closeActionModal()" [disabled]="processing">
          Cancel
        </button>
        <button type="button" 
                class="btn"
                [class.btn-success]="actionType === 'APPROVE'"
                [class.btn-danger]="actionType === 'REJECT'"
                [class.btn-warning]="actionType === 'ESCALATE_TO_COMPLIANCE'"
                (click)="confirmAction()" 
                [disabled]="processing || (actionType === 'REJECT' && !rejectionReason)">
          <span *ngIf="processing" class="spinner-border spinner-border-sm me-2"></span>
          {{ processing ? 'Processing...' : 'Confirm' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showActionModal" *ngIf="showActionModal"></div>
