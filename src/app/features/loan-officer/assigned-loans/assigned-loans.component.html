<!-- Assigned Loans Content -->

<!-- Loading State -->
<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-muted">Loading assigned loans...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="container-fluid py-4">
  <div class="alert alert-error-custom">
    <i class="fas fa-exclamation-circle"></i> {{ error }}
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid px-4 py-4" *ngIf="!loading">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 animate-fade-in">
    <div>
      <h2 class="h3 fw-bold mb-1" style="color: var(--text-primary);">
        <i class="fas fa-tasks me-2 text-primary"></i>Loan Management
      </h2>
      <p class="text-muted mb-0">Review and process your loan applications</p>
    </div>
    <div class="d-flex gap-2">
      <!-- View Toggle -->
      <div class="btn-group" role="group">
        <button type="button" 
                class="btn btn-sm"
                [class.btn-primary]="viewMode === 'table'"
                [class.btn-outline-primary]="viewMode !== 'table'"
                (click)="toggleView('table')"
                title="Table View">
          <i class="fas fa-table me-1"></i>Table
        </button>
        <button type="button" 
                class="btn btn-sm"
                [class.btn-primary]="viewMode === 'card'"
                [class.btn-outline-primary]="viewMode !== 'card'"
                (click)="toggleView('card')"
                title="Card View">
          <i class="fas fa-th-large me-1"></i>Cards
        </button>
      </div>
      <button class="btn btn-success" (click)="exportToCSV()" *ngIf="totalItems > 0">
        <i class="fas fa-download me-2"></i>Export to CSV
      </button>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="mb-4">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link" 
                [class.active]="activeTab === 'assigned'" 
                (click)="switchTab('assigned')" 
                type="button" 
                role="tab">
          <i class="fas fa-clock me-2"></i>Assigned Loans
          <span class="badge bg-primary ms-2">{{ assignedLoans.length }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" 
                [class.active]="activeTab === 'past'" 
                (click)="switchTab('past')" 
                type="button" 
                role="tab">
          <i class="fas fa-history me-2"></i>Past Loans
          <span class="badge bg-secondary ms-2">{{ pastLoans.length }}</span>
        </button>
      </li>
    </ul>
  </div>

  <!-- Filters Section -->
  <div class="card border-0 shadow-sm mb-4 animate-slide-up" style="animation-delay: 0.1s; background-color: var(--bg-primary);">
    <div class="card-body">
      <div class="row g-3">
        <!-- Search -->
        <div class="col-md-3">
          <label class="form-label small fw-semibold text-muted">Search</label>
          <input type="text" 
                 class="form-control" 
                 placeholder="Search by name, ID..." 
                 [(ngModel)]="searchQuery"
                 (ngModelChange)="applyFilters()"
                 style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
        </div>

        <!-- Status Filter -->
        <div class="col-md-2">
          <label class="form-label small fw-semibold text-muted">Status</label>
          <select class="form-select" 
                  [(ngModel)]="statusFilter"
                  (ngModelChange)="applyFilters()"
                  style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
            <option value="">All Status</option>
            <option *ngFor="let status of getStatusOptions()" [value]="status">{{ status }}</option>
          </select>
        </div>

        <!-- Risk Filter -->
        <div class="col-md-2">
          <label class="form-label small fw-semibold text-muted">Risk Level</label>
          <select class="form-select" 
                  [(ngModel)]="riskFilter"
                  (ngModelChange)="applyFilters()"
                  style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
            <option value="">All Risks</option>
            <option *ngFor="let risk of riskOptions" [value]="risk">{{ risk }}</option>
          </select>
        </div>

        <!-- Loan Type Filter -->
        <div class="col-md-3">
          <label class="form-label small fw-semibold text-muted">Loan Type</label>
          <select class="form-select" 
                  [(ngModel)]="loanTypeFilter"
                  (ngModelChange)="applyFilters()"
                  style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
            <option value="">All Types</option>
            <option *ngFor="let type of loanTypes" [value]="type">{{ type }}</option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
            <i class="fas fa-times me-2"></i>Clear
          </button>
        </div>
      </div>
      
      <div class="mt-3 text-muted small">
        Showing <strong>{{ paginatedLoans.length }}</strong> of <strong>{{ totalItems }}</strong> loans
        <span *ngIf="totalPages > 1"> (Page {{ currentPage }} of {{ totalPages }})</span>
      </div>
    </div>
  </div>

  <!-- Table View -->
  <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.2s; background-color: var(--bg-primary);" *ngIf="viewMode === 'table'">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead style="background-color: var(--bg-secondary); position: sticky; top: 0; z-index: 10;">
            <tr>
              <th style="color: var(--text-primary); padding: 1rem;">Assignment ID</th>
              <th style="color: var(--text-primary); padding: 1rem;">Applicant</th>
              <th style="color: var(--text-primary); padding: 1rem;">Loan Type</th>
              <th style="color: var(--text-primary); padding: 1rem;">Amount</th>
              <th style="color: var(--text-primary); padding: 1rem;">Status</th>
              <th style="color: var(--text-primary); padding: 1rem;">Assigned Date</th>
              <th style="color: var(--text-primary); padding: 1rem; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let loan of paginatedLoans" 
                class="loan-row"
                [class.table-warning]="loan.riskLevel === 'HIGH'"
                style="cursor: pointer;">
              <td style="color: var(--text-primary); padding: 1rem;">
                <strong>#{{ loan.assignmentId }}</strong>
              </td>
              <td style="color: var(--text-primary); padding: 1rem;">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2">
                    <i class="fas fa-user text-primary"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">{{ loan.applicantName }}</div>
                    <small class="text-muted">ID: {{ loan.applicantId }}</small>
                  </div>
                </div>
              </td>
              <td style="color: var(--text-primary); padding: 1rem;">
                <span class="badge bg-info">{{ loan.loanType }}</span>
              </td>
              <td style="color: var(--text-primary); padding: 1rem;">
                <span class="fw-semibold text-success">{{ formatCurrency(loan.loanAmount) }}</span>
              </td>
              <td style="padding: 1rem;">
                <span class="badge bg-{{ getStatusColor(loan.status) }}">{{ loan.status }}</span>
              </td>
              <td style="color: var(--text-secondary); padding: 1rem;">
                <small>{{ formatDate(loan.assignedAt) }}</small>
              </td>
              <td style="padding: 1rem; text-align: center;">
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-info" 
                          (click)="viewLoanDetails(loan)"
                          title="View Complete Loan Details">
                    <i class="fas fa-eye me-1"></i>View
                  </button>
                  <button class="btn btn-sm" 
                          [class.btn-primary]="!isLoanScreened(loan)"
                          [class.btn-info]="isLoanScreened(loan)"
                          (click)="startScreening(loan.assignmentId)"
                          [title]="isLoanScreened(loan) ? 'View Screening Results' : 'Start Screening Process'">
                    <i class="fas" 
                       [class.fa-search]="!isLoanScreened(loan)"
                       [class.fa-eye]="isLoanScreened(loan)"
                       class="me-1"></i>
                    {{ isLoanScreened(loan) ? 'Results' : 'Screen' }}
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Card View -->
  <div class="row g-4" *ngIf="viewMode === 'card'">
    <div class="col-lg-6" *ngFor="let loan of paginatedLoans; let i = index">
      <div class="loan-card card border-0 shadow-sm h-100 animate-slide-up" 
           [style.animation-delay.s]="(i * 0.1) + 0.2"
           style="background-color: var(--bg-primary);">
        <div class="card-body">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center gap-3">
              <div class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                <i class="fas fa-user-circle text-primary fs-3"></i>
              </div>
              <div>
                <h5 class="fw-bold mb-1" style="color: var(--text-primary);">{{ loan.applicantName }}</h5>
                <div class="d-flex gap-2">
                  <span class="badge bg-info small">{{ loan.loanType }}</span>
                </div>
              </div>
            </div>
            <span class="badge bg-{{ getStatusColor(loan.status) }}">{{ loan.status }}</span>
          </div>

          <!-- Details -->
          <div class="row g-3 mb-3">
            <div class="col-6">
              <div class="detail-item">
                <small class="text-muted d-block">Assignment ID</small>
                <strong style="color: var(--text-primary);">#{{ loan.assignmentId }}</strong>
              </div>
            </div>
            <div class="col-6">
              <div class="detail-item">
                <small class="text-muted d-block">Applicant ID</small>
                <strong style="color: var(--text-primary);">#{{ loan.applicantId }}</strong>
              </div>
            </div>
            <div class="col-6">
              <div class="detail-item">
                <small class="text-muted d-block">Loan Amount</small>
                <strong class="text-success">{{ formatCurrency(loan.loanAmount) }}</strong>
              </div>
            </div>
            <div class="col-6">
              <div class="detail-item">
                <small class="text-muted d-block">Risk Score</small>
                <strong [class]="'text-' + getRiskColor(loan.riskLevel)">{{ loan.riskScore }}/100</strong>
              </div>
            </div>
            <div class="col-12">
              <div class="detail-item">
                <small class="text-muted d-block">Assigned Date</small>
                <strong style="color: var(--text-primary);">{{ formatDate(loan.assignedAt) }}</strong>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row g-2">
            <div class="col-4">
              <button class="btn btn-info w-100" (click)="viewLoanDetails(loan)" title="View Details">
                <i class="fas fa-eye d-block mb-1"></i>
                <small>View</small>
              </button>
            </div>
            <div class="col-6">
              <button class="btn w-100" 
                      [class.btn-primary]="!isLoanScreened(loan)"
                      [class.btn-info]="isLoanScreened(loan)"
                      (click)="startScreening(loan.assignmentId)" 
                      [title]="isLoanScreened(loan) ? 'View Results' : 'Start Screening'">
                <i class="fas d-block mb-1" 
                   [class.fa-search]="!isLoanScreened(loan)"
                   [class.fa-eye]="isLoanScreened(loan)"></i>
                <small>{{ isLoanScreened(loan) ? 'Results' : 'Screen' }}</small>
              </button>
            </div>
          </div>

          <!-- High Risk Warning -->
          <div class="alert alert-warning mt-3 mb-0 small" *ngIf="loan.riskLevel === 'HIGH'">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>High Risk Alert:</strong> This application requires careful review
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="text-center py-5" *ngIf="paginatedLoans.length === 0 && !loading">
    <div class="empty-state">
      <i class="fas fa-inbox text-muted" style="font-size: 4rem;"></i>
      <h4 class="mt-3 text-muted">No Loans Found</h4>
      <p class="text-muted">Try adjusting your filters to see more results</p>
      <button class="btn btn-primary mt-2" (click)="clearFilters()" *ngIf="searchQuery || statusFilter || riskFilter || loanTypeFilter">
        <i class="fas fa-refresh me-2"></i>Clear All Filters
      </button>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div class="d-flex justify-content-between align-items-center mt-4" *ngIf="totalItems > 0">
    <div class="d-flex align-items-center gap-3">
      <span class="text-muted small">Items per page:</span>
      <select class="form-select form-select-sm" 
              style="width: auto; background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
              [(ngModel)]="itemsPerPage" 
              (ngModelChange)="changeItemsPerPage($event)">
        <option [value]="5" [selected]="itemsPerPage === 5">5</option>
        <option [value]="10" [selected]="itemsPerPage === 10">10</option>
        <option [value]="25" [selected]="itemsPerPage === 25">25</option>
        <option [value]="50" [selected]="itemsPerPage === 50">50</option>
      </select>
    </div>
    
    <nav aria-label="Pagination" *ngIf="totalPages > 1">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="prevPage()" [disabled]="currentPage === 1">
            <i class="fas fa-chevron-left"></i>
          </button>
        </li>
        
        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
          <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
            <i class="fas fa-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
    <div *ngIf="totalPages <= 1" class="text-center">
      <span class="text-muted small">All items shown on one page</span>
    </div>
    
    <div class="text-muted small">
      Showing {{ ((currentPage - 1) * itemsPerPage) + 1 }} to {{ Math.min(currentPage * itemsPerPage, totalItems) }} of {{ totalItems }} entries
    </div>
  </div>

</div>

<!-- Comprehensive Loan Details Modal -->
<div class="modal fade show d-block" *ngIf="showLoanDetailsModal && selectedLoan" 
     style="background-color: rgba(0,0,0,0.5);" 
     (click)="closeLoanDetailsModal()">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" (click)="$event.stopPropagation()">
    <div class="modal-content" style="background-color: var(--bg-primary);">
      <!-- Modal Header -->
      <div class="modal-header border-bottom" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title text-white fw-bold">
          <i class="fas fa-file-invoice me-2"></i>Complete Loan Application Details
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeLoanDetailsModal()"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4" style="max-height: 70vh; overflow-y: auto;">
        
        <!-- Applicant Information Section -->
        <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0 bg-primary bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-user-circle me-2 text-primary"></i>Applicant Information
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="small text-muted">Full Name</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">{{ selectedLoan.applicantName }}</p>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Applicant ID</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">#{{ selectedLoan.applicantId }}</p>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Customer ID</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">CUS-{{ selectedLoan.applicantId }}</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Contact Number</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i> Loading...</span>
                  <span *ngIf="!loadingDetails">{{ getApplicantPhone() }}</span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Email Address</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i> Loading...</span>
                  <span *ngIf="!loadingDetails">{{ getApplicantEmail() }}</span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Employment Status</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails" class="badge" 
                        [class.bg-success]="getEmploymentStatus() !== 'N/A'"
                        [class.bg-secondary]="getEmploymentStatus() === 'N/A'">
                    {{ getEmploymentStatus() }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Financial Metrics Section -->
        <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0 bg-success bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-chart-line me-2 text-success"></i>Financial Metrics
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="small text-muted">Credit Score (CIBIL)</label>
                <p class="fw-bold mb-0 fs-5" 
                   [class.text-success]="getCreditScore() >= 700"
                   [class.text-warning]="getCreditScore() >= 600 && getCreditScore() < 700"
                   [class.text-danger]="getCreditScore() < 600">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">{{ getCreditScore() || 'N/A' }}</span>
                </p>
                <small class="text-muted" *ngIf="!loadingDetails">
                  {{ getCreditScore() >= 700 ? 'Excellent' : getCreditScore() >= 600 ? 'Good' : 'Poor' }}
                </small>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">DTI Ratio</label>
                <p class="fw-bold mb-0 fs-5"
                   [class.text-success]="getDTIRatio() < 30"
                   [class.text-warning]="getDTIRatio() >= 30 && getDTIRatio() < 40"
                   [class.text-danger]="getDTIRatio() >= 40">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">{{ getDTIRatio() ? (getDTIRatio() | number: '1.1-1') + '%' : 'N/A' }}</span>
                </p>
                <small class="text-muted" *ngIf="!loadingDetails">
                  {{ getDTIRatio() < 30 ? 'Excellent' : getDTIRatio() < 40 ? 'Acceptable' : 'High' }}
                </small>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Monthly Income</label>
                <p class="fw-bold mb-0 text-primary fs-5">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">{{ getMonthlyIncome() ? formatCurrency(getMonthlyIncome()) : 'N/A' }}</span>
                </p>
                <small class="text-muted" *ngIf="!loadingDetails && getMonthlyIncome()">Verified</small>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Existing Debt</label>
                <p class="fw-bold mb-0 text-danger fs-5">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">
                    {{ detailedLoanData?.existingDebt ? formatCurrency(detailedLoanData.existingDebt) : 'N/A' }}
                  </span>
                </p>
                <small class="text-muted">Total borrowings</small>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Total Assets</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">
                    {{ detailedLoanData?.totalAssets ? formatCurrency(detailedLoanData.totalAssets) : 'N/A' }}
                  </span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Total Liabilities</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">
                    {{ detailedLoanData?.totalLiabilities ? formatCurrency(detailedLoanData.totalLiabilities) : 'N/A' }}
                  </span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Interest Coverage Ratio</label>
                <p class="fw-semibold mb-0 text-success">
                  <span *ngIf="loadingDetails"><i class="fas fa-spinner fa-spin"></i></span>
                  <span *ngIf="!loadingDetails">
                    {{ detailedLoanData?.interestCoverageRatio ? (detailedLoanData.interestCoverageRatio | number: '1.1-1') + 'x' : 'N/A' }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Loan Details Section -->
        <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0 bg-info bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-money-check-alt me-2 text-info"></i>Loan Details
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="small text-muted">Loan ID</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">#{{ selectedLoan.loanId }}</p>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Loan Type</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span class="badge bg-info">{{ selectedLoan.loanType }}</span>
                </p>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Requested Amount</label>
                <p class="fw-bold mb-0 text-success fs-5">{{ formatCurrency(selectedLoan.loanAmount) }}</p>
              </div>
              <div class="col-md-3">
                <label class="small text-muted">Loan Purpose</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">Home Purchase</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Proposed Interest Rate</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">8.5% p.a.</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Repayment Period</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">20 Years (240 months)</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Monthly EMI</label>
                <p class="fw-bold mb-0 text-primary">₹42,500</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Collateral Type</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">Property - Residential</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Collateral Value</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">₹75,00,000</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Loan-to-Value (LTV) Ratio</label>
                <p class="fw-semibold mb-0 text-success">66.67%</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Processing Fee</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">₹25,000</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Risk Assessment Section -->
        <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0" [class.bg-success]="selectedLoan.riskLevel === 'LOW'" 
                                            [class.bg-warning]="selectedLoan.riskLevel === 'MEDIUM'"
                                            [class.bg-danger]="selectedLoan.riskLevel === 'HIGH'"
                                            class="bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-shield-alt me-2" [class.text-success]="selectedLoan.riskLevel === 'LOW'" 
                                                 [class.text-warning]="selectedLoan.riskLevel === 'MEDIUM'"
                                                 [class.text-danger]="selectedLoan.riskLevel === 'HIGH'"></i>Risk Assessment
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="small text-muted">Risk Level</label>
                <p class="fw-bold mb-0">
                  <span class="badge bg-{{ getRiskColor(selectedLoan.riskLevel) }} fs-6">
                    {{ selectedLoan.riskLevel }} RISK
                  </span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Risk Score</label>
                <p class="fw-bold mb-0 fs-5" [class.text-success]="selectedLoan.riskLevel === 'LOW'" 
                                              [class.text-warning]="selectedLoan.riskLevel === 'MEDIUM'"
                                              [class.text-danger]="selectedLoan.riskLevel === 'HIGH'">
                  {{ selectedLoan.riskScore }}/100
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Can Approve/Reject</label>
                <p class="fw-semibold mb-0">
                  <span class="badge" [class.bg-success]="selectedLoan.canApproveReject" 
                                      [class.bg-warning]="!selectedLoan.canApproveReject">
                    {{ selectedLoan.canApproveReject ? 'Yes' : 'Needs Escalation' }}
                  </span>
                </p>
              </div>
              <div class="col-12">
                <label class="small text-muted">Risk Progress</label>
                <div class="progress" style="height: 25px;">
                  <div class="progress-bar" [class.bg-success]="selectedLoan.riskLevel === 'LOW'" 
                                             [class.bg-warning]="selectedLoan.riskLevel === 'MEDIUM'"
                                             [class.bg-danger]="selectedLoan.riskLevel === 'HIGH'"
                       [style.width.%]="selectedLoan.riskScore"
                       role="progressbar">
                    {{ selectedLoan.riskScore }}%
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status and Workflow Section -->
        <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0 bg-primary bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-tasks me-2 text-primary"></i>Status & Workflow
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="small text-muted">Current Status</label>
                <p class="fw-semibold mb-0">
                  <span class="badge bg-{{ getStatusColor(selectedLoan.status) }} fs-6">
                    {{ selectedLoan.status }}
                  </span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Processing Stage</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">Document Verification</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Assigned Officer</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">{{ selectedLoan.officerName }}</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Assignment ID</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">#{{ selectedLoan.assignmentId }}</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Assigned Date</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">{{ formatDate(selectedLoan.assignedAt) }}</p>
              </div>
              <div class="col-md-4">
                <label class="small text-muted">Days Pending</label>
                <p class="fw-semibold mb-0 text-warning">3 days</p>
              </div>
              <div class="col-12" *ngIf="selectedLoan.remarks">
                <label class="small text-muted">Officer Remarks</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">{{ selectedLoan.remarks }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Verification Status Section -->
        <div class="card border-0 shadow-sm" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0 bg-warning bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-check-double me-2 text-warning"></i>Verification Status
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle text-success fs-4 me-2"></i>
                  <div>
                    <small class="text-muted d-block">KYC Validation</small>
                    <span class="badge bg-success">Verified</span>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle text-success fs-4 me-2"></i>
                  <div>
                    <small class="text-muted d-block">Bank Account</small>
                    <span class="badge bg-success">Verified</span>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-center">
                  <i class="fas fa-clock text-warning fs-4 me-2"></i>
                  <div>
                    <small class="text-muted d-block">Employment Proof</small>
                    <span class="badge bg-warning">Pending</span>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-center">
                  <i class="fas fa-clock text-warning fs-4 me-2"></i>
                  <div>
                    <small class="text-muted d-block">Income Documents</small>
                    <span class="badge bg-warning">Pending</span>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-center">
                  <i class="fas fa-check-circle text-success fs-4 me-2"></i>
                  <div>
                    <small class="text-muted d-block">Address Proof</small>
                    <span class="badge bg-success">Verified</span>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-center">
                  <i class="fas fa-times-circle text-danger fs-4 me-2"></i>
                  <div>
                    <small class="text-muted d-block">Property Documents</small>
                    <span class="badge bg-danger">Missing</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" (click)="closeLoanDetailsModal()">
          <i class="fas fa-times me-2"></i>Close
        </button>
        <button type="button" 
                class="btn" 
                [class.btn-primary]="!isLoanScreened(selectedLoan)"
                [class.btn-info]="isLoanScreened(selectedLoan)"
                (click)="startScreening(selectedLoan.assignmentId); closeLoanDetailsModal()">
          <i class="fas me-2" 
             [class.fa-search]="!isLoanScreened(selectedLoan)"
             [class.fa-eye]="isLoanScreened(selectedLoan)"></i>
          {{ isLoanScreened(selectedLoan) ? 'View Results' : 'Start Screening' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Verification Modal -->
<div class="modal fade show d-block" *ngIf="showDocVerificationModal && selectedLoanForVerification" 
     style="background-color: rgba(0,0,0,0.5);" 
     (click)="closeDocumentVerificationModal()">
  <div class="modal-dialog modal-lg modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content" style="background-color: var(--bg-primary);">
      <!-- Modal Header -->
      <div class="modal-header border-bottom" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h5 class="modal-title text-white fw-bold">
          <i class="fas fa-file-check me-2"></i>Document Verification Required
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDocumentVerificationModal()"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <div class="alert alert-warning border-0 shadow-sm" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
            <i class="fas fa-exclamation-triangle text-warning fs-2 mb-2"></i>
            <h6 class="fw-bold mb-2" style="color: var(--text-primary);">Documents Not Verified</h6>
            <p class="mb-0 text-muted">All required documents must be verified before proceeding to loan screening.</p>
          </div>
        </div>

        <!-- Loan Information -->
        <div class="card border-0 shadow-sm mb-4" style="background-color: var(--bg-secondary);">
          <div class="card-header border-0 bg-primary bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-info-circle me-2 text-primary"></i>Loan Information
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="small text-muted">Applicant Name</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">{{ selectedLoanForVerification.applicantName }}</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Loan ID</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">#{{ selectedLoanForVerification.loanId }}</p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Loan Type</label>
                <p class="fw-semibold mb-0" style="color: var(--text-primary);">
                  <span class="badge bg-info">{{ selectedLoanForVerification.loanType }}</span>
                </p>
              </div>
              <div class="col-md-6">
                <label class="small text-muted">Loan Amount</label>
                <p class="fw-semibold mb-0 text-success">{{ formatCurrency(selectedLoanForVerification.loanAmount) }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Document Status -->
        <div class="card border-0 shadow-sm" style="background-color: var(--bg-secondary);" *ngIf="documentVerificationStatus">
          <div class="card-header border-0 bg-warning bg-opacity-10">
            <h6 class="fw-bold mb-0" style="color: var(--text-primary);">
              <i class="fas fa-file-alt me-2 text-warning"></i>Document Status
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="text-center">
                  <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="fas fa-file-alt text-primary fs-4"></i>
                  </div>
                  <h5 class="fw-bold mt-2 mb-1" style="color: var(--text-primary);">{{ documentVerificationStatus.totalDocuments || 0 }}</h5>
                  <small class="text-muted">Total Documents</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="fas fa-check-circle text-success fs-4"></i>
                  </div>
                  <h5 class="fw-bold mt-2 mb-1 text-success">{{ documentVerificationStatus.verifiedDocuments || 0 }}</h5>
                  <small class="text-muted">Verified</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="fas fa-clock text-warning fs-4"></i>
                  </div>
                  <h5 class="fw-bold mt-2 mb-1 text-warning">{{ documentVerificationStatus.pendingDocuments || 0 }}</h5>
                  <small class="text-muted">Pending</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="fas fa-times-circle text-danger fs-4"></i>
                  </div>
                  <h5 class="fw-bold mt-2 mb-1 text-danger">{{ documentVerificationStatus.rejectedDocuments || 0 }}</h5>
                  <small class="text-muted">Rejected</small>
                </div>
              </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4">
              <label class="small text-muted mb-2">Verification Progress</label>
              <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" 
                     [style.width.%]="documentVerificationStatus.totalDocuments > 0 ? (documentVerificationStatus.verifiedDocuments / documentVerificationStatus.totalDocuments) * 100 : 0"
                     role="progressbar">
                  {{ documentVerificationStatus.totalDocuments > 0 ? ((documentVerificationStatus.verifiedDocuments / documentVerificationStatus.totalDocuments) * 100).toFixed(0) : 0 }}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer border-top">
        <button type="button" class="btn btn-secondary" (click)="closeDocumentVerificationModal()">
          <i class="fas fa-times me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="proceedToDocumentVerification()">
          <i class="fas fa-file-check me-2"></i>Verify Documents
        </button>
      </div>
    </div>
  </div>
</div>
