<!-- Dashboard Content -->

<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
  </div>
  <p>Loading dashboard...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading && !stats" class="container-fluid py-4">
  <div class="alert alert-warning animate-slide-down">
    <i class="fas fa-info-circle me-2"></i>{{ error }}
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid px-4 py-4" *ngIf="!loading && stats">
  
  <!-- Welcome Banner -->
  <div class="card glass-effect mb-4 animate-fade-in hover-lift" 
       style="background: var(--gradient-primary); border: none;">
    <div class="card-body p-6">
      <div class="d-flex justify-content-between align-items-center text-white">
        <div>
          <h2 class="heading-lg mb-2 gradient-text" style="color: white !important;">Welcome back, {{ officerName }}! ðŸ‘‹</h2>
          <p class="text-body mb-0" style="color: rgba(255,255,255,0.9);">Here's what's happening with your loan assignments today</p>
        </div>
        <button class="btn btn-secondary hover-lift" (click)="viewAllLoans()">
          <i class="fas fa-tasks me-2"></i>View All Assignments
        </button>
      </div>
    </div>
  </div>

  <!-- Enhanced KPI Cards Row 1 -->
  <div class="row g-3 mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-1 shadow" style="border: 2px solid #1e40af; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Total Assigned</p>
              <h3 class="fw-bold mb-2" style="color: #1e40af !important; font-size: 1.75rem;">{{ stats.totalAssigned }}</h3>
              <div class="badge" style="background-color: #1e40af; color: white; font-size: 0.7rem;">
                <i class="fas fa-briefcase me-1"></i>
                Active
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #eff6ff; border-radius: 10px;">
              <i class="fas fa-briefcase" style="font-size: 1.2rem; color: #1e40af;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-2 shadow" style="border: 2px solid #d97706; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Pending Review</p>
              <h3 class="fw-bold mb-2" style="color: #d97706 !important; font-size: 1.75rem;">{{ stats.pendingReview }}</h3>
              <div class="badge" style="background-color: #d97706; color: white; font-size: 0.7rem;">
                <i class="fas fa-clock me-1"></i>
                Urgent
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #fef3c7; border-radius: 10px;">
              <i class="fas fa-clock" style="font-size: 1.2rem; color: #d97706;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-3 shadow" style="border: 2px solid #059669; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Approval Rate</p>
              <h3 class="fw-bold mb-2" style="color: #059669 !important; font-size: 1.75rem;">{{ stats.approvalRate | number:'1.1-1' }}%</h3>
              <div class="badge" [style.background-color]="stats.approvalRate >= 70 ? '#059669' : stats.approvalRate >= 50 ? '#d97706' : '#dc2626'" style="color: white; font-size: 0.7rem;">
                <i class="fas fa-chart-line me-1"></i>
                {{ getPerformanceText(stats.approvalRate) }}
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #d1fae5; border-radius: 10px;">
              <i class="fas fa-percentage" style="font-size: 1.2rem; color: #059669;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-4 shadow" style="border: 2px solid #0891b2; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Total Funded</p>
              <h3 class="fw-bold mb-2" style="color: #0891b2 !important; font-size: 1.4rem;">{{ formatCurrency(stats.totalFundedAmount) }}</h3>
              <div class="badge" style="background-color: #0891b2; color: white; font-size: 0.7rem;">
                <i class="fas fa-coins me-1"></i>
                Disbursed
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #cffafe; border-radius: 10px;">
              <i class="fas fa-rupee-sign" style="font-size: 1.2rem; color: #0891b2;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced KPI Cards Row 2 -->
  <div class="row g-3 mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up shadow" style="animation-delay: 0.5s; border: 2px solid #10b981; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Loan Quality Index</p>
              <h3 class="fw-bold mb-2" style="font-size: 1.75rem;" [style.color]="stats.loanQualityIndex >= 80 ? '#10b981' : stats.loanQualityIndex >= 60 ? '#d97706' : '#dc2626'">
                {{ stats.loanQualityIndex | number:'1.1-1' }}%
              </h3>
              <div class="badge" [style.background-color]="stats.loanQualityIndex >= 80 ? '#10b981' : stats.loanQualityIndex >= 60 ? '#d97706' : '#dc2626'" style="color: white; font-size: 0.7rem;">
                <i class="fas fa-star me-1"></i>
                {{ getQualityText(stats.loanQualityIndex) }}
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #d1fae5; border-radius: 10px;">
              <i class="fas fa-award" style="font-size: 1.2rem; color: #10b981;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up shadow" style="animation-delay: 0.6s; border: 2px solid #3b82f6; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Underwriting Accuracy</p>
              <h3 class="fw-bold mb-2" style="color: #3b82f6 !important; font-size: 1.75rem;">{{ stats.underwritingAccuracy | number:'1.1-1' }}%</h3>
              <div class="badge" style="background-color: #3b82f6; color: white; font-size: 0.7rem;">
                <i class="fas fa-bullseye me-1"></i>
                Precision
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #dbeafe; border-radius: 10px;">
              <i class="fas fa-crosshairs" style="font-size: 1.2rem; color: #3b82f6;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up shadow" style="animation-delay: 0.7s; border: 2px solid #f59e0b; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">Average DTI Ratio</p>
              <h3 class="fw-bold mb-2" style="font-size: 1.75rem;" [style.color]="stats.averageDTI <= 30 ? '#10b981' : stats.averageDTI <= 40 ? '#f59e0b' : '#dc2626'">
                {{ stats.averageDTI | number:'1.1-1' }}%
              </h3>
              <div class="badge" [style.background-color]="stats.averageDTI <= 30 ? '#10b981' : stats.averageDTI <= 40 ? '#f59e0b' : '#dc2626'" style="color: white; font-size: 0.7rem;">
                <i class="fas fa-balance-scale me-1"></i>
                Risk
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #fef3c7; border-radius: 10px;">
              <i class="fas fa-calculator" style="font-size: 1.2rem; color: #f59e0b;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="card hover-lift animate-slide-up shadow" style="animation-delay: 0.8s; border: 2px solid #dc2626; background: #ffffff; min-height: 120px;">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-medium" style="font-size: 0.85rem; color: #6b7280 !important;">High Risk Cases</p>
              <h3 class="fw-bold mb-2" style="color: #dc2626 !important; font-size: 1.75rem;">{{ stats.highRiskCount }}</h3>
              <div class="badge" style="background-color: #dc2626; color: white; font-size: 0.7rem;">
                <i class="fas fa-exclamation-triangle me-1"></i>
                {{ getHighRiskPercentage() }}%
              </div>
            </div>
            <div class="ms-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #fee2e2; border-radius: 10px;">
              <i class="fas fa-shield-alt" style="font-size: 1.2rem; color: #dc2626;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Charts Row 1 -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.1s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-pie me-2 text-primary"></i>Status Distribution
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container chart-wrapper" style="height: 300px; position: relative;">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.2s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-bar me-2 text-primary"></i>Risk Level Distribution
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container chart-wrapper" style="height: 300px; position: relative;">
            <canvas id="riskChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Risk Analysis & Quality Metrics -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.5s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-shield-alt me-2 text-warning"></i>Risk Analysis
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="text-center p-3 rounded" style="background-color: var(--bg-secondary);">
                <div class="risk-circle mx-auto mb-2" style="width: 80px; height: 80px; border-radius: 50%; border: 8px solid #10b981; display: flex; align-items: center; justify-content: center;">
                  <div class="text-center">
                    <div class="fw-bold text-success">{{ stats.lowRiskCount }}</div>
                    <small class="text-muted">Low</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-3 rounded" style="background-color: var(--bg-secondary);">
                <div class="risk-circle mx-auto mb-2" style="width: 80px; height: 80px; border-radius: 50%; border: 8px solid #f59e0b; display: flex; align-items: center; justify-content: center;">
                  <div class="text-center">
                    <div class="fw-bold text-warning">{{ stats.mediumRiskCount }}</div>
                    <small class="text-muted">Medium</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="text-center p-3 rounded" style="background-color: var(--bg-secondary);">
                <div class="risk-circle mx-auto mb-2" style="width: 100px; height: 100px; border-radius: 50%; border: 10px solid #ef4444; display: flex; align-items: center; justify-content: center;">
                  <div class="text-center">
                    <div class="fw-bold text-danger fs-4">{{ stats.highRiskCount }}</div>
                    <small class="text-muted">High Risk</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.6s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-trophy me-2 text-warning"></i>Quality Metrics
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Underwriting Accuracy</span>
              <span class="fw-bold text-primary">{{ stats.underwritingAccuracy | number:'1.1-1' }}%</span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                   [style.width.%]="stats.underwritingAccuracy" 
                   role="progressbar"></div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Loan Quality Index</span>
              <span class="fw-bold" [class.text-success]="stats.loanQualityIndex >= 80" [class.text-warning]="stats.loanQualityIndex >= 60 && stats.loanQualityIndex < 80" [class.text-danger]="stats.loanQualityIndex < 60">
                {{ stats.loanQualityIndex | number:'1.1-1' }}%
              </span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   [class.bg-success]="stats.loanQualityIndex >= 80" 
                   [class.bg-warning]="stats.loanQualityIndex >= 60 && stats.loanQualityIndex < 80" 
                   [class.bg-danger]="stats.loanQualityIndex < 60"
                   [style.width.%]="stats.loanQualityIndex" 
                   role="progressbar"></div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Portfolio Yield</span>
              <span class="fw-bold text-success">{{ stats.portfolioYield | number:'1.1-1' }}%</span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                   [style.width.%]="stats.portfolioYield * 10" 
                   role="progressbar"></div>
            </div>
          </div>

          <div class="row g-2 mt-3">
            <div class="col-6">
              <div class="text-center p-2 rounded" style="background-color: var(--bg-secondary);">
                <div class="fw-bold text-success">{{ stats.goodLoansCount }}</div>
                <small class="text-muted">Good Loans</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-2 rounded" style="background-color: var(--bg-secondary);">
                <div class="fw-bold text-danger">{{ stats.badLoansCount }}</div>
                <small class="text-muted">High-Risk Approved</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Assignments -->
  <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 0.7s; background-color: var(--bg-primary);">
    <div class="card-header border-0 d-flex justify-content-between align-items-center" style="background-color: var(--bg-primary);">
      <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
        <i class="fas fa-list me-2 text-primary"></i>Recent Assignments
      </h5>
      <button class="btn btn-sm btn-outline-primary" (click)="viewAllLoans()">
        View All <i class="fas fa-arrow-right ms-1"></i>
      </button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead style="background-color: var(--bg-secondary);">
            <tr>
              <th style="color: var(--text-primary);">Applicant</th>
              <th style="color: var(--text-primary);">Loan Type</th>
              <th style="color: var(--text-primary);">Amount</th>
              <th style="color: var(--text-primary);">Risk Level</th>
              <th style="color: var(--text-primary);">Status</th>
              <th style="color: var(--text-primary);">Assigned Date</th>
              <th style="color: var(--text-primary);">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let loan of recentLoans" class="loan-row">
              <td style="color: var(--text-primary);">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2">
                    <i class="fas fa-user text-primary"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">{{ loan.applicantName }}</div>
                    <small class="text-muted">ID: {{ loan.applicantId }}</small>
                  </div>
                </div>
              </td>
              <td style="color: var(--text-primary);">
                <span class="badge bg-info">{{ loan.loanType }}</span>
              </td>
              <td style="color: var(--text-primary);">
                <span class="fw-semibold">{{ formatCurrency(loan.loanAmount) }}</span>
              </td>
              <td>
                <span class="badge bg-{{ getRiskColor(loan.riskLevel) }}">
                  <i class="fas fa-circle-notch fa-spin me-1" *ngIf="loan.riskLevel === 'HIGH'"></i>
                  {{ loan.riskLevel }}
                </span>
              </td>
              <td>
                <span class="badge bg-{{ getStatusColor(loan.status) }}">{{ loan.status }}</span>
              </td>
              <td style="color: var(--text-secondary);">{{ formatDate(loan.assignedAt) }}</td>
              <td>
                <button class="btn btn-sm btn-primary" (click)="reviewLoan(loan.assignmentId)">
                  <i class="fas fa-eye me-1"></i>Review
                </button>
              </td>
            </tr>
            <tr *ngIf="recentLoans.length === 0">
              <td colspan="7" class="text-center text-muted py-4">
                <i class="fas fa-inbox fs-3 mb-2 d-block"></i>
                No recent assignments
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
