<!-- Dashboard Content -->

<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
  </div>
  <p>Loading dashboard...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading && !stats" class="container-fluid py-4">
  <div class="alert alert-warning animate-slide-down">
    <i class="fas fa-info-circle me-2"></i>{{ error }}
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid px-4 py-4" *ngIf="!loading && stats">
  
  <!-- Welcome Banner -->
  <div class="card glass-effect mb-4 animate-fade-in hover-lift" 
       style="background: var(--gradient-primary); border: none;">
    <div class="card-body p-6">
      <div class="d-flex justify-content-between align-items-center text-white">
        <div>
          <h2 class="heading-lg mb-2 gradient-text" style="color: white !important;">Welcome back, {{ officerName }}! ðŸ‘‹</h2>
          <p class="text-body mb-0" style="color: rgba(255,255,255,0.9);">Here's what's happening with your loan assignments today</p>
        </div>
        <button class="btn btn-secondary hover-lift" (click)="viewAllLoans()">
          <i class="fas fa-tasks me-2"></i>View All Assignments
        </button>
      </div>
    </div>
  </div>

  <!-- Primary KPI Cards Row 1 -->
  <div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-1" style="border: 2px solid var(--primary-blue); background: linear-gradient(135deg, var(--white) 0%, rgba(30, 64, 175, 0.02) 100%);">
        <div class="card-body p-6">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-caption text-muted mb-2">Total Assigned</p>
              <h3 class="heading-md mb-2" style="color: var(--primary-blue);">{{ stats.totalAssigned }}</h3>
              <div class="badge badge-primary">
                <i class="fas fa-arrow-up me-1" *ngIf="stats.totalAssigned > 0"></i>
                Active workload
              </div>
            </div>
            <div class="kpi-icon primary">
              <i class="fas fa-briefcase"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-2" style="border: 2px solid var(--warning-amber); background: linear-gradient(135deg, var(--white) 0%, rgba(217, 119, 6, 0.02) 100%);">
        <div class="card-body p-6">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-caption text-muted mb-2">Pending Review</p>
              <h3 class="heading-md mb-2" style="color: var(--warning-amber);">{{ stats.pendingReview }}</h3>
              <div class="badge badge-warning">
                <i class="fas fa-clock me-1"></i>
                Needs attention
              </div>
            </div>
            <div class="kpi-icon warning">
              <i class="fas fa-clock"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-3" style="border: 2px solid var(--success-green); background: linear-gradient(135deg, var(--white) 0%, rgba(5, 150, 105, 0.02) 100%);">
        <div class="card-body p-6">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-caption text-muted mb-2">Approval Rate</p>
              <h3 class="heading-md mb-2" style="color: var(--success-green);">{{ stats.approvalRate | number:'1.1-1' }}%</h3>
              <div class="badge" [ngClass]="stats.approvalRate >= 70 ? 'badge-success' : stats.approvalRate >= 50 ? 'badge-warning' : 'badge-danger'">
                <i class="fas fa-chart-line me-1"></i>
                {{ getPerformanceText(stats.approvalRate) }}
              </div>
            </div>
            <div class="kpi-icon success">
              <i class="fas fa-percentage"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card hover-lift animate-slide-up animate-stagger-4" style="border: 2px solid var(--info-cyan); background: linear-gradient(135deg, var(--white) 0%, rgba(8, 145, 178, 0.02) 100%);">
        <div class="card-body p-6">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-caption text-muted mb-2">Total Funded</p>
              <h3 class="heading-md mb-2" style="color: var(--info-cyan);">{{ formatCurrency(stats.totalFundedAmount) }}</h3>
              <div class="badge badge-info">
                <i class="fas fa-coins me-1"></i>
                Approved loans
              </div>
            </div>
            <div class="kpi-icon info">
              <i class="fas fa-rupee-sign"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance KPI Cards Row 2 -->
  <div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="stat-card card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.5s; background-color: var(--bg-primary);">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-2 small">Loan Quality Index</p>
              <h3 class="fw-bold mb-0 counter" [class.text-success]="stats.loanQualityIndex >= 80" [class.text-warning]="stats.loanQualityIndex >= 60 && stats.loanQualityIndex < 80" [class.text-danger]="stats.loanQualityIndex < 60">
                {{ stats.loanQualityIndex | number:'1.1-1' }}%
              </h3>
              <small class="text-muted">
                <i class="fas fa-star me-1" [class.text-success]="stats.loanQualityIndex >= 80" [class.text-warning]="stats.loanQualityIndex >= 60 && stats.loanQualityIndex < 80" [class.text-danger]="stats.loanQualityIndex < 60"></i>
                {{ getQualityText(stats.loanQualityIndex) }}
              </small>
            </div>
            <div class="stat-icon bg-success bg-opacity-10 rounded-3 p-3">
              <i class="fas fa-award text-success fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="stat-card card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.6s; background-color: var(--bg-primary);">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-2 small">Underwriting Accuracy</p>
              <h3 class="fw-bold mb-0 counter text-primary">{{ stats.underwritingAccuracy | number:'1.1-1' }}%</h3>
              <small class="text-muted">
                <i class="fas fa-bullseye me-1"></i>
                Decision precision
              </small>
            </div>
            <div class="stat-icon bg-primary bg-opacity-10 rounded-3 p-3">
              <i class="fas fa-crosshairs text-primary fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="stat-card card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.7s; background-color: var(--bg-primary);">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-2 small">Average DTI Ratio</p>
              <h3 class="fw-bold mb-0 counter" [class.text-success]="stats.averageDTI <= 30" [class.text-warning]="stats.averageDTI > 30 && stats.averageDTI <= 40" [class.text-danger]="stats.averageDTI > 40">
                {{ stats.averageDTI | number:'1.1-1' }}%
              </h3>
              <small class="text-muted">
                <i class="fas fa-balance-scale me-1"></i>
                Risk indicator
              </small>
            </div>
            <div class="stat-icon bg-warning bg-opacity-10 rounded-3 p-3">
              <i class="fas fa-calculator text-warning fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="stat-card card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.8s; background-color: var(--bg-primary);">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-2 small">High Risk Cases</p>
              <h3 class="fw-bold mb-0 counter text-danger">{{ stats.highRiskCount }}</h3>
              <small class="text-muted">
                <i class="fas fa-exclamation-triangle me-1"></i>
                {{ getHighRiskPercentage() }}% of total
              </small>
            </div>
            <div class="stat-icon bg-danger bg-opacity-10 rounded-3 p-3">
              <i class="fas fa-shield-alt text-danger fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Metrics Row -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.9s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i>Performance Metrics
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="performance-metric text-center p-3 rounded" style="background-color: var(--bg-secondary);" data-tooltip="Total loans approved">
                <div class="fw-bold text-success fs-4 counter">{{ stats.approved }}</div>
                <small class="text-muted">Approved</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="performance-metric text-center p-3 rounded" style="background-color: var(--bg-secondary);" data-tooltip="Total loans rejected">
                <div class="fw-bold text-danger fs-4 counter">{{ stats.rejected }}</div>
                <small class="text-muted">Rejected</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="performance-metric text-center p-3 rounded" style="background-color: var(--bg-secondary);" data-tooltip="Loans escalated to compliance">
                <div class="fw-bold text-info fs-4 counter">{{ stats.escalated }}</div>
                <small class="text-muted">Escalated</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="performance-metric text-center p-3 rounded" style="background-color: var(--bg-secondary);" data-tooltip="Total loans processed">
                <div class="fw-bold text-primary fs-4 counter">{{ getProcessedCount() }}</div>
                <small class="text-muted">Processed</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row 1 -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.1s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-pie me-2 text-primary"></i>Status Distribution
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container chart-wrapper" style="height: 300px; position: relative;">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.2s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-bar me-2 text-primary"></i>Risk Level Distribution
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container chart-wrapper" style="height: 300px; position: relative;">
            <canvas id="riskChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row 2 - Performance Analytics -->
  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.3s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-line me-2 text-success"></i>Performance Trends
          </h5>
          <small class="text-muted">Monthly approval rate and quality index trends</small>
        </div>
        <div class="card-body">
          <div class="chart-container chart-wrapper" style="height: 350px; position: relative;">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.4s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-chart-area me-2 text-info"></i>Loan Type Distribution
          </h5>
          <small class="text-muted">Portfolio composition</small>
        </div>
        <div class="card-body">
          <div class="chart-container chart-wrapper" style="height: 350px; position: relative;">
            <canvas id="loanTypeChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Risk Analysis & Quality Metrics -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.5s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-shield-alt me-2 text-warning"></i>Risk Analysis
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="text-center p-3 rounded" style="background-color: var(--bg-secondary);">
                <div class="risk-circle mx-auto mb-2" style="width: 80px; height: 80px; border-radius: 50%; border: 8px solid #10b981; display: flex; align-items: center; justify-content: center;">
                  <div class="text-center">
                    <div class="fw-bold text-success">{{ stats.lowRiskCount }}</div>
                    <small class="text-muted">Low</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-3 rounded" style="background-color: var(--bg-secondary);">
                <div class="risk-circle mx-auto mb-2" style="width: 80px; height: 80px; border-radius: 50%; border: 8px solid #f59e0b; display: flex; align-items: center; justify-content: center;">
                  <div class="text-center">
                    <div class="fw-bold text-warning">{{ stats.mediumRiskCount }}</div>
                    <small class="text-muted">Medium</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="text-center p-3 rounded" style="background-color: var(--bg-secondary);">
                <div class="risk-circle mx-auto mb-2" style="width: 100px; height: 100px; border-radius: 50%; border: 10px solid #ef4444; display: flex; align-items: center; justify-content: center;">
                  <div class="text-center">
                    <div class="fw-bold text-danger fs-4">{{ stats.highRiskCount }}</div>
                    <small class="text-muted">High Risk</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 1.6s; background-color: var(--bg-primary);">
        <div class="card-header border-0 pb-0" style="background-color: var(--bg-primary);">
          <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
            <i class="fas fa-trophy me-2 text-warning"></i>Quality Metrics
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Underwriting Accuracy</span>
              <span class="fw-bold text-primary">{{ stats.underwritingAccuracy | number:'1.1-1' }}%</span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                   [style.width.%]="stats.underwritingAccuracy" 
                   role="progressbar"></div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Loan Quality Index</span>
              <span class="fw-bold" [class.text-success]="stats.loanQualityIndex >= 80" [class.text-warning]="stats.loanQualityIndex >= 60 && stats.loanQualityIndex < 80" [class.text-danger]="stats.loanQualityIndex < 60">
                {{ stats.loanQualityIndex | number:'1.1-1' }}%
              </span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   [class.bg-success]="stats.loanQualityIndex >= 80" 
                   [class.bg-warning]="stats.loanQualityIndex >= 60 && stats.loanQualityIndex < 80" 
                   [class.bg-danger]="stats.loanQualityIndex < 60"
                   [style.width.%]="stats.loanQualityIndex" 
                   role="progressbar"></div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Portfolio Yield</span>
              <span class="fw-bold text-success">{{ stats.portfolioYield | number:'1.1-1' }}%</span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                   [style.width.%]="stats.portfolioYield * 10" 
                   role="progressbar"></div>
            </div>
          </div>

          <div class="row g-2 mt-3">
            <div class="col-6">
              <div class="text-center p-2 rounded" style="background-color: var(--bg-secondary);">
                <div class="fw-bold text-success">{{ stats.goodLoansCount }}</div>
                <small class="text-muted">Good Loans</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-2 rounded" style="background-color: var(--bg-secondary);">
                <div class="fw-bold text-danger">{{ stats.badLoansCount }}</div>
                <small class="text-muted">High-Risk Approved</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Assignments -->
  <div class="card border-0 shadow-sm animate-fade-in" style="animation-delay: 0.7s; background-color: var(--bg-primary);">
    <div class="card-header border-0 d-flex justify-content-between align-items-center" style="background-color: var(--bg-primary);">
      <h5 class="fw-semibold mb-0" style="color: var(--text-primary);">
        <i class="fas fa-list me-2 text-primary"></i>Recent Assignments
      </h5>
      <button class="btn btn-sm btn-outline-primary" (click)="viewAllLoans()">
        View All <i class="fas fa-arrow-right ms-1"></i>
      </button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead style="background-color: var(--bg-secondary);">
            <tr>
              <th style="color: var(--text-primary);">Applicant</th>
              <th style="color: var(--text-primary);">Loan Type</th>
              <th style="color: var(--text-primary);">Amount</th>
              <th style="color: var(--text-primary);">Risk Level</th>
              <th style="color: var(--text-primary);">Status</th>
              <th style="color: var(--text-primary);">Assigned Date</th>
              <th style="color: var(--text-primary);">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let loan of recentLoans" class="loan-row">
              <td style="color: var(--text-primary);">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2">
                    <i class="fas fa-user text-primary"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">{{ loan.applicantName }}</div>
                    <small class="text-muted">ID: {{ loan.applicantId }}</small>
                  </div>
                </div>
              </td>
              <td style="color: var(--text-primary);">
                <span class="badge bg-info">{{ loan.loanType }}</span>
              </td>
              <td style="color: var(--text-primary);">
                <span class="fw-semibold">{{ formatCurrency(loan.loanAmount) }}</span>
              </td>
              <td>
                <span class="badge bg-{{ getRiskColor(loan.riskLevel) }}">
                  <i class="fas fa-circle-notch fa-spin me-1" *ngIf="loan.riskLevel === 'HIGH'"></i>
                  {{ loan.riskLevel }}
                </span>
              </td>
              <td>
                <span class="badge bg-{{ getStatusColor(loan.status) }}">{{ loan.status }}</span>
              </td>
              <td style="color: var(--text-secondary);">{{ formatDate(loan.assignedAt) }}</td>
              <td>
                <button class="btn btn-sm btn-primary" (click)="reviewLoan(loan.assignmentId)">
                  <i class="fas fa-eye me-1"></i>Review
                </button>
              </td>
            </tr>
            <tr *ngIf="recentLoans.length === 0">
              <td colspan="7" class="text-center text-muted py-4">
                <i class="fas fa-inbox fs-3 mb-2 d-block"></i>
                No recent assignments
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
