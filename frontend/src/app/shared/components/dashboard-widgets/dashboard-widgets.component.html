<!-- Dashboard Widgets Container -->
<div class="widgets-container" [style.--grid-columns]="gridColumns">
  <div *ngFor="let widget of widgets; trackBy: trackByWidgetId"
       class="widget-wrapper"
       [class]="getWidgetGridClass(widget)"
       [class.loading]="isLoading[widget.id]"
       [class.error]="errors[widget.id]">
    
    <!-- Widget Content -->
    <div class="widget-card" [class]="'widget-' + widget.type">
      
      <!-- Widget Header -->
      <div class="widget-header">
        <div class="widget-title">
          <i *ngIf="widget.icon" [class]="widget.icon" [style.color]="widget.color"></i>
          <span>{{ widget.title }}</span>
        </div>
        <div class="widget-actions">
          <button class="widget-action-btn" 
                  (click)="refreshWidget(widget)"
                  [disabled]="isLoading[widget.id]"
                  title="Refresh">
            <i class="fas fa-sync-alt" [class.fa-spin]="isLoading[widget.id]"></i>
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading[widget.id]" class="widget-loading">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Loading...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="errors[widget.id] && !isLoading[widget.id]" class="widget-error">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{ errors[widget.id] }}</p>
        <button class="retry-btn" (click)="refreshWidget(widget)">
          <i class="fas fa-redo"></i> Retry
        </button>
      </div>

      <!-- Widget Content -->
      <div *ngIf="!isLoading[widget.id] && !errors[widget.id]" class="widget-content">
        
        <!-- Stat Widget -->
        <div *ngIf="widget.type === 'stat'" class="stat-widget">
          <div class="stat-value" [class]="'status-' + widgetData[widget.id]?.status">
            {{ widgetData[widget.id]?.value }}
          </div>
          <div class="stat-label">{{ widgetData[widget.id]?.label }}</div>
          
          <!-- Trend Indicator -->
          <div *ngIf="widgetData[widget.id]?.trend !== undefined" 
               class="stat-trend"
               [class]="'trend-' + widgetData[widget.id]?.trendDirection">
            <i [class]="getTrendIcon(widgetData[widget.id]?.trendDirection)"></i>
            <span>{{ Math.abs(widgetData[widget.id]?.trend) }}%</span>
          </div>
        </div>

        <!-- Chart Widget -->
        <div *ngIf="widget.type === 'chart'" class="chart-widget">
          <div class="chart-container">
            <canvas [id]="'chart-' + widget.id"></canvas>
          </div>
        </div>

        <!-- Progress Widget -->
        <div *ngIf="widget.type === 'progress'" class="progress-widget">
          <div class="progress-header">
            <span class="progress-label">{{ widgetData[widget.id]?.label }}</span>
            <span class="progress-value">{{ widgetData[widget.id]?.progress }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" 
                 [style.width.%]="widgetData[widget.id]?.progress"
                 [class]="'status-' + widgetData[widget.id]?.status">
            </div>
          </div>
          
          <!-- System Metrics -->
          <div *ngIf="widgetData[widget.id]?.metadata" class="system-metrics">
            <div class="metric-item">
              <span class="metric-label">CPU</span>
              <div class="metric-bar">
                <div class="metric-fill" [style.width.%]="widgetData[widget.id]?.metadata?.cpu"></div>
              </div>
              <span class="metric-value">{{ widgetData[widget.id]?.metadata?.cpu }}%</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Memory</span>
              <div class="metric-bar">
                <div class="metric-fill" [style.width.%]="widgetData[widget.id]?.metadata?.memory"></div>
              </div>
              <span class="metric-value">{{ widgetData[widget.id]?.metadata?.memory }}%</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Storage</span>
              <div class="metric-bar">
                <div class="metric-fill" [style.width.%]="widgetData[widget.id]?.metadata?.storage"></div>
              </div>
              <span class="metric-value">{{ widgetData[widget.id]?.metadata?.storage }}%</span>
            </div>
          </div>
        </div>

        <!-- List Widget -->
        <div *ngIf="widget.type === 'list'" class="list-widget">
          <div *ngIf="widgetData[widget.id]?.listItems?.length === 0" class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>No items to display</p>
          </div>
          
          <div *ngFor="let item of widgetData[widget.id]?.listItems" 
               class="list-item"
               [class]="'status-' + item.status">
            <div class="item-icon">
              <i [class]="item.icon" [class]="'status-' + item.status"></i>
            </div>
            <div class="item-content">
              <div class="item-title">{{ item.title }}</div>
              <div class="item-description">{{ item.description }}</div>
              <div class="item-timestamp">{{ getRelativeTime(item.timestamp) }}</div>
            </div>
            <div class="item-status">
              <span class="status-badge" [class]="'status-' + item.status">
                {{ item.status | titlecase }}
              </span>
            </div>
          </div>
        </div>

        <!-- Activity Widget -->
        <div *ngIf="widget.type === 'activity'" class="activity-widget">
          <div *ngIf="widgetData[widget.id]?.listItems?.length === 0" class="empty-state">
            <i class="fas fa-history"></i>
            <p>No recent activities</p>
          </div>
          
          <div class="activity-timeline">
            <div *ngFor="let activity of widgetData[widget.id]?.listItems; let i = index" 
                 class="activity-item"
                 [style.--delay]="i * 0.1 + 's'">
              <div class="activity-marker">
                <i [class]="activity.icon" [class]="'status-' + activity.status"></i>
              </div>
              <div class="activity-content">
                <div class="activity-title">{{ activity.title }}</div>
                <div class="activity-description">{{ activity.description }}</div>
                <div class="activity-time">{{ getRelativeTime(activity.timestamp) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Metric Widget -->
        <div *ngIf="widget.type === 'metric'" class="metric-widget">
          <div class="metric-circle">
            <svg class="metric-svg" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" 
                      class="metric-bg"
                      fill="none" 
                      stroke="#e5e7eb" 
                      stroke-width="8"/>
              <circle cx="50" cy="50" r="45"
                      class="metric-progress"
                      fill="none"
                      [attr.stroke]="widget.color || '#3b82f6'"
                      stroke-width="8"
                      stroke-linecap="round"
                      [style.stroke-dasharray]="283"
                      [style.stroke-dashoffset]="283 - (283 * (widgetData[widget.id]?.progress || 0) / 100)"
                      transform="rotate(-90 50 50)"/>
            </svg>
            <div class="metric-text">
              <div class="metric-percentage">{{ widgetData[widget.id]?.progress || 0 }}%</div>
              <div class="metric-label">{{ widgetData[widget.id]?.label }}</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Widget Footer -->
      <div *ngIf="widgetData[widget.id]?.lastUpdated && !isLoading[widget.id] && !errors[widget.id]" 
           class="widget-footer">
        <small>
          <i class="fas fa-clock"></i>
          Last updated: {{ getRelativeTime(widgetData[widget.id]?.lastUpdated!) }}
        </small>
      </div>
    </div>
  </div>
</div>
